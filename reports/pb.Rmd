---
title: "PB"
author: Renata Diaz
date: "`r Sys.Date()`"
output: 
    github_document:
       df_print: kable
       toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.dim =c(8, 4))
library(soar)
library(ggplot2)
library(dplyr)

theme_set(theme_bw())
```

```{r}
plot_ps <- get_plot_totals(use_pre_switch = F)

treat_ps <- get_treatment_means(use_pre_switch = F) 
```

```{r}

ggplot(filter(plot_ps), aes(censusdate, pb_e_ma,group = plot, color = oplottype)) +
  geom_line() +
  facet_wrap(vars(oplottype)) +
  ggtitle("PB - all time")

ggplot(filter(plot_ps, as.numeric(oera) > 2), aes(censusdate, pb_e_ma,group = plot, color = oplottype)) +
  geom_line() +
  facet_wrap(vars(oplottype)) +
  ggtitle("PB - since 2010ish")



ggplot(filter(plot_ps), aes(censusdate, pb_e_ma/total_e_ma,group = plot, color = oplottype)) +
  geom_line() +
  facet_wrap(vars(oplottype)) +
  ggtitle("PB as percent of plot energy - all time") +
  geom_line(data = filter(treat_ps), aes(censusdate, pb_e_ma/total_e_ma, color = oplottype), inherit.aes = F, size = 2)

ggplot(filter(plot_ps, as.numeric(oera) > 2), aes(censusdate, pb_e_ma / total_e_ma,group = plot, color = oplottype)) +
  geom_line() +
  facet_wrap(vars(oplottype)) +
  ggtitle("PB as percent of plot energy - since 2010ish") +
  geom_line(data = filter(treat_ps, as.numeric(oera) > 2), aes(censusdate, pb_e_ma/total_e_ma, color = oplottype), inherit.aes = F, size = 2)
```

### models

```{r}

library(mgcv)

plot_ps_pb <- plot_ps %>%
  mutate(pb_prop = pb_e / total_e) %>%
  filter(as.numeric(oera) > 1) %>%
  mutate(pb_prop = ifelse(is.nan(pb_prop), 0, pb_prop),
         row = dplyr::row_number())

cc_era4 <- plot_ps_pb %>%
  filter(plot_type=="CC", as.numeric(oera) == 4) %>%
  select(row)

plot_ps_pb <- plot_ps_pb %>%
  filter(!(row %in% cc_era4$row))



#qbin_gam <- gam(pb_prop ~ s(period, by = fplottype, k = 50) + s(fplot, bs = "re"), data = plot_ps_pb, family = quasibinomial())
qbin_gam <- gam(pb_prop ~ s(period, by = fplottype), data = plot_ps_pb, family = quasibinomial())

qbin_fit <- plot_ps_pb %>%
  gratia::add_fitted(qbin_gam, exclude = "s(fplot)") 

cc_era4 <- qbin_fit %>%
  filter(plot_type=="CC", as.numeric(oera) == 4) %>%
  select(row)
qbin_fit <- qbin_fit%>%
  filter(!(row %in% cc_era4$row))

ggplot(qbin_fit, aes(period, .value,color = fplottype)) +
  geom_line() +
  geom_line(data = filter(treat_ps, as.numeric(oera) > 1), aes(period, pb_e_ma/total_e_ma, color = oplottype), inherit.aes = F)

library(gratia)
library(emmeans)


qbin_confint <- confint(qbin_gam, parm = "s(period)", type = "simultaneous", shift= T, transform = T, newdata = plot_ps_pb) %>%
  right_join(select(plot_ps_pb, period, oera)) %>%
  mutate(row = dplyr::row_number()) 


cc_era4 <- qbin_confint %>%
  filter(fplottype=="CC", as.numeric(oera) == 4) %>%
  select(row)

qbin_confint <- qbin_confint %>%
  filter(!(row %in% cc_era4$row))

ggplot(qbin_confint, aes(period, est, color = fplottype, fill = fplottype)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .3) +
  facet_wrap(vars(fplottype))


qbin_int_gam <- gam(pb_prop ~ oera * oplottype + s(fplot, bs = "re"), family = quasibinomial(), data= plot_ps_pb)

qbin_int_gam_fit <- plot_ps_pb %>%
  add_fitted(qbin_int_gam, exclude = "s(fplot)")

ggplot(qbin_int_gam_fit, aes(censusdate, .value, color = oplottype)) +
  geom_line()

pairs(emmeans(qbin_int_gam, specs = ~ oera | oplottype))
regrid(emmeans(qbin_int_gam, specs = ~ oera | oplottype))

qbin_glm <- glm(pb_prop ~ oera * oplottype, family = quasibinomial(), data= plot_ps_pb)

summary(qbin_glm)

ilink <- qbin_glm$family$linkinv

qbin_glm_se <- predict(qbin_glm, type = "link", se.fit = T, newdata = plot_ps_pb) %>%
  as.data.frame() %>%
  mutate(est = ilink(fit),
         lower = ilink(fit - 2*se.fit),
         upper = ilink(fit + 2*se.fit),
         period = plot_ps_pb$period,
         oplottype = plot_ps_pb$oplottype)


ggplot(qbin_glm_se, aes(period, est, color = oplottype, fill = oplottype)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax= upper), alpha = .3)


pairs(emmeans(qbin_glm, specs = ~ oera | oplottype))

qbin_glm_se <- qbin_glm_se %>%
  right_join(select(plot_ps_pb, oera, oplottype, period))


qbin_glm_se %>%
  select(oera, oplottype, est, lower, upper) %>%
  distinct()

treat_ps %>%
  group_by(oera, oplottype) %>%
  summarize(mean_pb_prop = mean(pb_e / total_e, na.rm = T)) %>%
  ungroup()
```



KKKK, the above code is a mess, but things I think I'm learning...

- PB has declined sitewide, raw and as a proportion of total energy use. 
- It is now totally absent on control plots. (this creates a bunch of issues for glms, so I removed the data - all 0s - for CC era 4)
- There are a lot of modeling options and none of them are perfect. Some notes on the considerations:
    - The GAMs fit with a smooth for period and a random effect  for plot were doing a really bad job; they'd fit control higher than any other treatment even though that's just Wrong. This might be fixable by increasing the k for the period smooth, but I haven't gone deep in there because models with high k take a while to run and this isn't exactly what I'm trying to learn right now. 
    - I've been working with both betar() and quasibinomial() as GAM/GLM families. I think they give essentially the same results in this application, but haven't tested extensively.

What I really wanted to know was,

how much energy is PB using *now* on exclosures vs. when it was more dominant? And that looks like, an estimate now of about 14-18% post-2010 compared to about 60% pre-2010. Compared to, essentially none on control plots. (Although note, oddly enough, it was more abundant on C --> E plots prior to the switch than on C --> C plots. I see this a bunch and I think it means we can't use those plots to get at priority effects.)