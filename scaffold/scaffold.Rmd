---
title: "Scaffolding analysis with plot switch data"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
```

# Data

This document uses the data from the plots studied in Christensen et al 2019 ProcB. We will use some of the same control plots for the actual analysis, but both sets of treatment plots will be different. (Ch uses exclosures that get turned into controls and removals that get turned into controls. We will look at long term exclosures and controls that get turned into exclosures).

This gives us space to do some analytical development without wondering if we're seeing the actual effects. We have the same basic structures we will have in the actual data:

- Three treatment types - controls and two flavors of manipulation
- Changes to the manipulations occurring in 2015
- Probably similar sitewide dynamics in terms of fluctuations in sitewide abundance, major environmental events, etc. 
- Probably similar idiosyncracies in the data, e.g. variability between plots; autocorrelation; etc.

```{r}

rats <- read.csv(here::here("lore", "2020_redux", "christensen_plots.csv")) %>%
  mutate(plot = factor(plot),
         treatment = factor(treatment)) %>%
  filter(!is.na(species))

```

```{r}

rats_types_totals <- rats %>%
  #mutate(plot = as.ordered(plot),
 #        treatment = as.ordered(treatment)) %>%
  select(period, treatment, type, plot, energy) %>%
  group_by(period, treatment, type, plot) %>%
  summarize(nind = dplyr::n(),
            totale = sum(energy))  %>%
  ungroup() 


all_types <- expand.grid(period = unique(rats$period), plot = unique(rats$plot), type = unique(rats$type)) %>%
  left_join(distinct(select(rats, plot, treatment)))

rats_types_totals <- left_join(all_types, rats_types_totals)%>%
  mutate(nind = ifelse(is.na(nind), 0, nind),
         totale = ifelse(is.na(totale), 0, totale))
  

rats_totals <- rats %>% 
  mutate(plot = factor(plot),
         treatment = factor(treatment)) %>%
  select(period, treatment, plot, energy) %>%
  group_by(period, treatment, plot) %>%
  summarize(nind = dplyr::n(),
            totale = sum(energy)) %>%
  ungroup() 


all_totals <- expand.grid(period = unique(rats$period), plot = unique(rats$plot)) %>%
  left_join(distinct(select(rats, plot, treatment)))

rats_totals <- left_join(all_totals, rats_totals) %>%
  mutate(nind = ifelse(is.na(nind), 0, nind),
         totale = ifelse(is.na(totale), 0, totale))

major_changes <- c(118, 216, 356, 434) # beginning of Thibault data, Bailey's arrival, 2010 (changepoint), 2015 (treatments)

```

Here is the raw data, crudely smoothed for visualization:

```{r}
ggplot(filter(rats_totals), aes(period, nind, color = treatment, group = plot)) +
 geom_smooth(se = F, size = 2) +  theme_bw() +
  scale_color_viridis_d(end = .8)  +ggtitle("Number of individuals")

# 
# ggplot(filter(rats_types_totals, type == "small_granivore"), aes(period, nind,  color = treatment, group = plot)) +
#  geom_smooth(se = F, size = 2) +  theme_bw() +
#   scale_color_viridis_d(end = .8)  +ggtitle("Number of individuals - small granivores")

ggplot(filter(rats_totals), aes(period, totale, color = treatment, group = plot)) +
 geom_smooth(se = F, size = 2) +  theme_bw() +
  scale_color_viridis_d(end = .8) + ggtitle("Energy use") 



```

# 1. Does the energetic compensation persist over time?

## GAM

We fit a GAM to `energy ~ treatment + s(period) + s(period, by = treatment)` with a Tweedie link. We include all treatments and all time in this GAM, because we'll use it repeatedly. Treatment is ordered.

```{r}


energy <- filter(rats_totals) %>%
  mutate(oplot = ordered(plot),
         otreatment = as.ordered(treatment),
         type = "all") %>%
  as.data.frame() %>%
  mutate(era = NA) %>%
  mutate(era = ifelse(
    period <= 118, "a_pre_th",
    ifelse(period <= 216, "b_pre_ba",
           ifelse(period <= 356, "c_pre_cpt",
                  ifelse(period <= 434, "d_pre_switch", "e_post-switch"))))) %>%
  mutate(oera = as.ordered(era))


library(mgcv)
source(here::here("lore", "1994_longterm", "gams_fxns_generalized.R"))

#e.mod <- gam(totale ~  otreatment + s(period, k = 100) + s(period, by = otreatment, k = 100), family = "tw", data  = energy)
e.mod <- gam(totale ~  otreatment + s(period, k = 20) + s(period, by = otreatment, k = 20), family = "tw", data  = energy)
# This k is too low but it takes forever to render with 100
#summary(e.mod)

#gam.check(e.mod)

e.pdat <- make_pdat(energy, include_plot = F, comparison_variable = "otreatment")

e.pred <- get_predicted_vals(e.mod, e.pdat)  %>%
  mutate(era = NA) %>%
  mutate(era = ifelse(
    period <= 118, "a_pre_th",
    ifelse(period <= 216, "b_pre_ba",
           ifelse(period <= 356, "c_pre_cpt",
                  ifelse(period <= 434, "d_pre_switch", "e_post-switch"))))) %>%
  mutate(oera = as.ordered(era))


```

Here is the fitted values from that GAM:

```{r}

plot_fitted_pred(e.pred, comparison_variable = "otreatment") + ylab("Energy use") +
  geom_vline(xintercept = major_changes)
```

In specific "eras":

```{r}

plot_fitted_pred(filter(e.pred, era != "a_pre_th"), comparison_variable = "otreatment") + ylab("Energy use") +
  facet_wrap(vars(era), scales = "free_x", nrow = 1)

```
For this uestion, we are interested in comparing CC to EC (for the sake of argument). 

The GAM is useful for 1) visualization and 2) computing the difference between the smooths and seeing if it overlaps zero, i.e. they are essentially the same.


```{r}

cc_ec <- get_exclosure_diff(e.mod, e.pdat, comparison_variable = "otreatment") %>%
  left_join(select(e.pred, period, era))

plot_exclosure_diff(filter(cc_ec, era != "a_pre_th")) +
  facet_wrap(vars(era), scales = "free_x", nrow = 1)

e.newdiff <- add_exclosure_diff(e.pred, cc_ec)

plot_fitted_pred(filter(e.newdiff, era != "a_pre_th", otreatment != "XC"), comparison_variable = "otreatment") + ylab("Energy use") +
  facet_wrap(vars(era), scales = "free_x", nrow = 1)

```
The smooths do indeed diverge prior to Bailey's establishment, get close and even overlap temporarily for the Thibault/Ernest papers era. Here, they diverge following, to a somewhat lesser but still appreciable degree! They converge following the switch, which is expected because the switch is ex -> control; this is documented in Ch.

Possible behaviors we could see in the actual data: diverging and continuing to diverge post-treatment (we don't expect the treatment to change longterm exclosures that...stay exclosures); moving back to convergence at some point. 

#### Details RMD is still working on

- Plot effect - tends to make the GAM behave really poory
- Ordered v. unordered factor

## Comparing eras

```{r}

energy_ratio <- energy %>%
  group_by(period, treatment, type, era, oera, otreatment) %>%
  summarize(totale = sum(totale),
            nplots = length(unique(plot))) %>%
  ungroup() %>%
  mutate(meane = totale/nplots) %>%
  tidyr::pivot_wider(id_cols = c(period, type, era, oera), names_from = treatment, values_from = meane) %>%
  mutate(ECr = EC/ CC,
         XCr = XC/CC) %>%
  dplyr::select(period, era, ECr, XCr) %>%
  tidyr::pivot_longer(cols = c(ECr, XCr), names_to = "ref", values_to = "ratio") %>%
  group_by(period,  ref) %>%
  mutate(mean_ratio = mean(ratio)) %>%
  ungroup() %>%
  mutate(ratio = ifelse(ratio == 0, 0.0000001, ratio)) %>%
  mutate(era = as.factor(era), ref = as.factor(ref))

ggplot(energy_ratio, aes(period, ratio, color = ref)) +
  geom_line() + 
  geom_line(aes(period, mean_ratio)) + facet_wrap(vars(era), scales = "free_x", nrow = 1) + theme_bw() +
  geom_smooth(method = "lm", formula = y ~ 1, se = T)
# 
# energy_ratio %>%
#   select(era, mean_ratio) %>%
#   distinct()

# energy_ratio %>%
#   select(era, mean_ratio, mean_ex_ratio) %>%
#   distinct()

e_glm <- glm(ratio ~ era * ref, family = Gamma, data = energy_ratio)

summary(e_glm)

#library(multcomp)
#library(lsmeans)
#summary(glht(e_glm, mcp(era = "Tukey", ref = "Tukey", era * ref = "Tukey"))) Can't do interactions with glht, can  try lsmeans

e_glm_pred <- predict(e_glm, se.fit = T)

ratio_pred <- energy_ratio %>%
  mutate(linkfit = e_glm_pred$fit,
         linkupper = e_glm_pred$se.fit + e_glm_pred$fit,
         linklower = e_glm_pred$fit -e_glm_pred$se.fit) %>%
  mutate(invlinkfit = 1/linkfit,
         invlinklower = 1/linklower,
         invlinkupper = 1/linkupper)

ggplot(filter(ratio_pred, ref == "ECr"), aes(period, invlinkfit, color = ref)) +
  geom_line() +
  geom_ribbon(aes(ymin = invlinklower, ymax = invlinkupper), alpha = .5)

```

RMD is working on a way to test the differences between eras. Kelt used repeated measures ANOVA; Thibault use t-tests. In both cases they are asking whether control = exclosure, and the answer is always no. It is not appropriate to compare across time in terms of **total** energy, but it does seem appropriate to compare across times in terms of the **ratio** of energy. RMD is therefore interested in a model that will either 1) estimate the ratio in each time period and allow us to compare the ratio estimates across time periods or 2) estimate the actual energy values according to treatment and time period, and allow us to compare the difference between the estimates across time periods. I think 1) can be accomplished via a (generalized) linear model. We may be able to incorporate a temporal autocorrelation structure if we do a glmm.

# 2. Does the energetic compensation happen consistent in the new exclosures?

## GAM

Here the uestion is whether the third treatment group - for now, XC - converges to match the second treatment group - EC - following the switch. 

```{r}


ec_xc <- get_exclosure_diff(e.mod, e.pdat, reference_level = 2, comparison_level = 3, comparison_variable = "otreatment")

plot_exclosure_diff(ec_xc)

e.origdiff <- add_exclosure_diff(e.pred, ec_xc)  %>%
  mutate(era = NA) %>%
  mutate(era = ifelse(
    period <= 118, "a_pre_th",
    ifelse(period <= 216, "b_pre_ba",
           ifelse(period <= 356, "c_pre_cpt",
                  ifelse(period <= 434, "d_pre_switch", "e_post-switch"))))) %>%
  mutate(oera = as.ordered(era))

plot_fitted_pred(filter(e.origdiff, otreatment != "CC"), comparison_variable = "otreatment") + ylab("Energy use") +
  facet_wrap(vars(era), scales = "free_x", nrow = 1)

```

We may also be able to look at how the difference between the two treatments and the reference level compare:

```{r}

cc_xc <- get_exclosure_diff(e.mod, e.pdat, reference_level = 1, comparison_level = 3, comparison_variable = "otreatment") %>%
  mutate(comparison_level = "XC")

cc_ec <- cc_ec %>%
  mutate(comparison_level = "EC")

both_diffs <- bind_rows(cc_xc, cc_ec)  %>%
  mutate(era = NA) %>%
  mutate(era = ifelse(
    period <= 118, "a_pre_th",
    ifelse(period <= 216, "b_pre_ba",
           ifelse(period <= 356, "c_pre_cpt",
                  ifelse(period <= 434, "d_pre_switch", "e_post-switch"))))) %>%
  mutate(oera = as.ordered(era))

ggplot(both_diffs, aes(period, fitted_dif, color = comparison_level, fill = comparison_level)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .5) +
  facet_wrap(vars(era), scale = "free_x", nrow = 1)+ theme_bw() + theme(legend.position = "top")
```
This looks to me like the *offset* between the control and the treatment plots is uite different for a while - e.g. the difference between the control and XC is really high for c_pre_cpt, but low for the difference between the control and EC - but the offsets for the different treatment types becomes similar after the switch. (Which, again, we expect since they converge; see Ch.)

## Comparing the ratios

```{r}

ggplot(filter(ratio_pred), aes(period, invlinkfit, color = ref)) +
  geom_line() +
  geom_ribbon(aes(ymin = invlinklower, ymax = invlinkupper), alpha = .5)


```

Here they converge (we expect them to). If they don't...why?


# 3. Do we see differences in the plant community between old and new exclosures before the switch?

This is context for, if we're not seeing the same response in the new exclosures, a possible plant-mediated effect. 

pCCA separately on winter and summer, suare root transformed. This is how both Supp (2012) and Ch (2019) did this.

