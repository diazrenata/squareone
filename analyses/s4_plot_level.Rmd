---
title: "Appendix S4 - Plot-level analysis"
subtitle: "Supplemental information for Diaz and Ernest, “Maintenance of community function through compensation breaks down over time in a desert rodent community”. In review at Ecology."
output:
  # html_document:
  #   toc: yes
  #   df_print: paged
  word_document:
    df_print: kable
    reference_docx: default_gdoc.docx
    toc: yes
  # pdf_document:
  #   toc: yes
  #   df_print: kable
---

```{r setup, include=T, echo = F, results = F, warning = F, message = F}
knitr::opts_chunk$set(echo = F,  warning = F, message = F)

library(soar)
library(ggplot2)
library(dplyr)
library(multipanelfigure)
library(nlme)
library(emmeans)

theme_set(theme_bw())


# Get data using `portalr`:
#treatl <- get_treatment_means() 
# Alternatively, read data from `data/`:
# treatl <- read.csv(here::here("data", "treatl.csv"), stringsAsFactors = T)

# This section is new. Load data using `get_plot_totals` so that you can remove an exclosure plot (resulting in a balanced set of 4 exclosures and 4 controls)

plotl <- get_plot_totals()

plot_types <- list_plot_types() %>% filter(plot_type == "EE")

set.seed(1977) # 1977 is my usual Portal seed
remove_plot <- sample(plot_types$plot, 1, F)

plotl <- plotl %>%
  filter(plot != remove_plot)

```

\newpage

# Explanation

In order to  calculate energetic compensation and the total energy ratio, we require an estimate for the baseline values of total energy use, kangaroo rat energy use, and small granivore energy use on control plots. Estimating these baselines requires aggregating over between-plot variability among the control plots. For consistency, in the main analysis, we also aggregate across the exclosure plots and focus on treatment-level means throughout. Here, we explore the effect of between-plot variability on our analyses by examining the effect of plot as a random factor within exclosure plots (for total energy and compensation) and across all plots involved in analyses of proportional energy use (controls and exclosures for *C. baileyi*, and only controls for *Dipodomys*). 

# Calculations of compensation and the total energy ratio

```{r, echo = T}

control_means <- plotl %>%
  filter(plot_type == "CC") %>%
  group_by(period) %>%
  summarize(mean_total_e = mean(total_e),
            mean_dipo_e = mean(dipo_e),
            mean_smgran_e = mean(smgran_e)) %>%
  ungroup() 

plotl_vars <- plotl %>%
  left_join(control_means) %>%
  mutate(energy_ratio = total_e / mean_total_e,
         compensation = (smgran_e - mean_smgran_e) / mean_dipo_e,
         dipo_ratio = dipo_e / total_e,
         pb_ratio = pb_e / total_e) %>%
  filter(plot != remove_plot)

compensation_dat <- filter(plotl_vars, oplottype == "EE")
total_e_dat <- filter(plotl_vars, oplottype == "EE")
pb_dat <- filter(plotl_vars, as.numeric(oera) > 1)
dipo_c_dat <- filter(plotl_vars, oplottype == "CC")
```

\newpage

# Compensation

## Model specification and selection

We fit linear mixed-effects models fitting `compensation ~ time period` with a random effect of plot and a temporal autocorrelation term to account for autocorrelation between monthly census periods within each timeperiod. We compare these to models without the autocorrelation term, without the random effect, and without the term for time period. 

The best-model (lowest AIC) is the full model (terms for time period, autocorrelation, and a random effect of plot) with an AIC of 1360.207. 

```{r, echo =T}

# Full model:
comp_plot_gls <- lme(compensation ~ oera , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = compensation_dat)

# No autocorrelation term:
comp_plot_gls_noautoc <- lme(compensation ~ oera , random = ~1|fplot, data = compensation_dat)

# No random effect of plot:
comp_plot_gls_norandom <- gls(compensation ~ oera , correlation = corCAR1(form = ~ period | fplot), data = compensation_dat)

# No term for time period:
comp_plot_gls_notime <- lme(compensation ~ 1 , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = compensation_dat)

# No term for time period, or autocorrelation term:
comp_plot_gls_notime_nocor <- lme(compensation ~ 1 , random = ~1|fplot, data = compensation_dat)

# No terms - intercept-only null model:
comp_plot_gls_notime_nocor_norand <- gls(compensation ~ 1 , data = compensation_dat)

AIC(comp_plot_gls)
AIC(comp_plot_gls_noautoc)
AIC(comp_plot_gls_norandom)
AIC(comp_plot_gls_notime)
AIC(comp_plot_gls_notime_nocor)
AIC(comp_plot_gls_notime_nocor_norand)

```

We proceed with estimates and contrasts from the full model.

```{r, echo = T}
comp_mean_gls_emmeans <- emmeans(comp_plot_gls, specs = ~ oera)



```

\newpage

## Results

### Table S1. Coefficients from linear mixed-effects model for compensation

```{r}
compensation_coef <- as.data.frame(summary(comp_plot_gls)$tTable)
compensation_coef
```


### Table S2. Estimates from linear mixed-effects model for compensation 

```{r}

compensation_estimates <- as.data.frame(comp_mean_gls_emmeans)
compensation_estimates

```

### Table S3. Contrasts from linear mixed-effects model for compensation 

```{r}
compensation_contrasts <- as.data.frame(pairs(comp_mean_gls_emmeans)) %>%
  mutate(p.value = round(p.value, digits = 4))
compensation_contrasts

```
\newpage
 
# Total energy use

## Model specification and selection


As for compensation, fit linear mixed-effects models fitting `total_energy_ratio ~ time period` with a random effect of plot and a temporal autocorrelation term to account for autocorrelation between monthly census periods within each timeperiod. We compare these to models without the autocorrelation term, without the random effect, and without the term for time period. 

The best-model (lowest AIC) is the full model (terms for time period, autocorrelation, and a random effect of plot) with an AIC of 474.8. 

```{r, echo = T}

totale_plot_gls <- lme(energy_ratio~ oera , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = total_e_dat)

totale_plot_gls_noautoc <- lme(energy_ratio~ oera , random = ~1|fplot, data = total_e_dat)

totale_plot_gls_norandom <- gls(energy_ratio~ oera , correlation = corCAR1(form = ~ period | fplot), data = total_e_dat)


totale_plot_gls_notime <- lme(energy_ratio~ 1 , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = total_e_dat)
totale_plot_gls_notime_nocor <- lme(energy_ratio~ 1 , random = ~1|fplot, data = total_e_dat)
totale_plot_gls_notime_nocor_norand <- gls(energy_ratio~ 1 , data = total_e_dat)

AIC(totale_plot_gls)
AIC(totale_plot_gls_noautoc)
AIC(totale_plot_gls_norandom)
AIC(totale_plot_gls_notime)
AIC(totale_plot_gls_notime_nocor)
AIC(totale_plot_gls_notime_nocor_norand)


  
```


We proceed with estimates and contrasts from the full model.

```{r, echo = T}
totale_mean_gls_emmeans <- emmeans(totale_plot_gls, specs = ~ oera)

```


\newpage

## Results
### Table S4. Coefficients from linear mixed-effects model on total energy ratio

```{r}

te_coef <- as.data.frame(summary(totale_plot_gls)$tTable)

te_coef

```


### Table S5. Estimates from linear mixed-effects model on total energy ratio

```{r}

totale_estimates <- as.data.frame(totale_mean_gls_emmeans)
totale_estimates

```


### Table S6. Contrasts from linear mixed-effects model on total energy ratio

```{r}
totale_contrasts <- as.data.frame(pairs(totale_mean_gls_emmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
totale_contrasts

```

\newpage



# Kangaroo rat proportional energy use


```{r, echo = F}
library(lme4)

dipo_glmer <- glmer(dipo_ratio ~ oera + (1|fplot), data = dipo_c_dat, family = binomial)
dipo_glm <- glm(dipo_ratio ~ oera, data = dipo_c_dat, family = binomial)

AIC(dipo_glmer)
AIC(dipo_glm)

```

### Table S7. Coefficients from GLM on Dipodomys energy use.

```{r}

dipo_coef <- as.data.frame(summary(dipo_glmer)$coefficients)
dipo_coef

```


### Table S8. Estimates from GLM on Dipodomys energy use.

```{r}


dipoemmeans <- regrid(emmeans(dipo_glmer, specs = ~ oera))

dipoestimates <- as.data.frame(dipoemmeans)

dipoestimates

```


### Table S9. Contrasts from GLMER on Dipodomys energy use.

```{r}
dipocontrasts <- as.data.frame(pairs(dipoemmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
dipocontrasts

```

\newpage

# C. baileyi proportional energy use


```{r, echo = F}

pb_glmer_interaction <- glmer(pb_ratio ~ oera * oplottype + (1|fplot), data = pb_dat, family = binomial)
pb_glmer_nointeraction <- glmer(pb_ratio ~ oera + oplottype + (1|fplot), data = pb_dat, family = binomial)
pb_glmer_notreat <- glmer(pb_ratio ~ oera + (1|fplot), data = pb_dat, family = binomial)
pb_glmer_notime <- glmer(pb_ratio ~ 1 + (1|fplot), data = pb_dat, family = binomial)


pb_glm_interaction <- glm(pb_ratio ~ oera * oplottype , data = pb_dat, family = binomial)
pb_glm_nointeraction <- glm(pb_ratio ~ oera + oplottype , data = pb_dat, family = binomial)
pb_glm_notreat <- glm(pb_ratio ~ oera, data = pb_dat, family = binomial)
pb_glm_notime <- glm(pb_ratio ~ 1, data = pb_dat, family = binomial)



AIC(pb_glmer_interaction)
AIC(pb_glmer_nointeraction)
AIC(pb_glmer_notreat)
AIC(pb_glmer_notime)

AIC(pb_glm_interaction)
AIC(pb_glm_nointeraction)
AIC(pb_glm_notreat)
AIC(pb_glm_notime)


```



### Table S10. Coefficients from GLM on C. baileyi energy use

```{r}

pb_coef <- as.data.frame(summary(pb_glmer_nointeraction)$coefficients)
pb_coef

```


### Table S11. Estimates from GLM on C. baileyi energy use

```{r}

pb_emmeans <- regrid(emmeans(pb_glmer_nointeraction, specs = ~ oera))

pb_estimates <- as.data.frame(pb_emmeans)

pb_estimates

```

### Table S12. Contrasts from GLM on C. baileyi energy use.

```{r}
pb_contrasts <- as.data.frame(pairs(pb_emmeans)) %>%
  mutate(p.value = round(p.value, digits = 4))
pb_contrasts

```
