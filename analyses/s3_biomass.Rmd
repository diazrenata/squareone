---
title: "Appendix S3 - Biomass analysis"
subtitle: "Supplemental information for Diaz and Ernest, “Maintenance of community function through compensation breaks down over time in a desert rodent community”. In review at Ecology."
output: 
   # github_document:
   #      df_print: kable
   #      toc: true
   #pdf_document 
    word_document:
          df_print: kable
          reference_docx: default_gdoc.docx
          toc: yes
---

```{r setup, include=FALSE, message = F, warning= F}
knitr::opts_chunk$set(echo = FALSE,  message = F, warning= F)
library(soar)
library(ggplot2)
library(dplyr)
library(multipanelfigure)
library(nlme)
library(emmeans)

## Get data using `portalr`:
# plotl <- get_plot_totals(currency = "biomass")
# plot_types <- list_plot_types()
# Or, load:
plotl <- read.csv(here::here("data", "plotl_biomass.csv"), stringsAsFactors = T)

plot_types <- read.csv(here::here("data", "plot_types.csv"), stringsAsFactors = T)


plot_types <- plot_types  %>% 
  filter(plot_type == "EE")

# Remove 1 of 5 exclosure plots
set.seed(1977) # 1977 is my usual Portal seed
remove_plot <- sample(plot_types$plot, 1, F)

plotl <- plotl %>%
  filter(plot != remove_plot)

treatl <- plots_to_treatment_means(plotl) 

treatl <- treatl %>%
  mutate(censusdate = as.Date(censusdate),
         oera = ordered(oera),
         oplottype = ordered(oplottype))

pb <- get_pb(treatl) 

pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)
energy_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)
dipo_c_dat <- get_dipo_c(treatl)


# For figures:

theme_set(theme_bw())

both_scale <- scale_color_viridis_d(option = "cividis", begin = .1, end = .8, direction = -1)
both_fscale <- scale_fill_viridis_d(option = "cividis", begin = .1, end = .8, direction = -1)

#era_df <- make_era_df()
# Alternatively, get the era_df from `data/`:
era_df <- read.csv(here::here("data", "era_df.csv"))
era_df <- era_df %>%
  mutate(event_date = as.Date(event_date),
         no_name = "")

```

\newpage

```{r}


comp_mean_gls <- gls(smgran_comp ~ oera,  correlation = corCAR1(form = ~ period), data = compensation)

comp_mean_gls_emmeans <- emmeans(comp_mean_gls, specs = ~ oera)

comp_mean_pred <-  as.data.frame(comp_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(compensation)

comp_title <- expression(paste(bold("B."), " Biomass compensation"))

comp_plot <- ggplot(filter(comp_mean_pred, oplottype %in% c("CC", "EE")), aes(censusdate, emmean)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL), alpha = .2) +
  geom_line(aes(y = smgran_comp_ma)) +
  ggtitle(comp_title) +
  ylab(bquote((SG[E] - SG[C]) / KR[C])) +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = -.05, yend = 1.4), linetype = 3)+
  xlab("") +
  theme(title = element_text(size = 7),
        axis.title.y = element_text(size =  7), 
        axis.text = element_text(size = 6)) + 
  xlab("")

```


```{r}

totale_mean_gls <- gls(total_e_rat ~  oera,  correlation = corCAR1(form = ~ period), data = energy_ratio)


totale_mean_gls_emmeans <- emmeans(totale_mean_gls, specs = ~ oera)


totale_mean_pred <- as.data.frame(totale_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(energy_ratio)


te_title <- expression(paste(bold("A."), " Total biomass"))


totale_plot <- ggplot(filter(totale_mean_pred, oplottype %in% c("CC", "EE")), aes(censusdate, emmean)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL), alpha = .2) +
  geom_line(aes(y = total_e_rat_ma)) +
  ggtitle(te_title) +
  ylab(bquote(Btot[E] / Btot[C])) +
  theme(legend.position = "none") +
  ylim(-0, 1.2) +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = 0, yend = 1.2), linetype = 3) +
  theme(title = element_text(size = 7), 
        axis.title.y = element_text(size =  7),  
        axis.text = element_text(size = 6)) + 
  xlab("")


```

```{r}



pb_glm_nointeraction <- glm(pb_prop ~ oera + oplottype, family = binomial(), data= pb_nozero)


pb_glm_nointeraction_se <- est_glm_ilink(pb_glm_nointeraction, pb_nozero) %>%
  full_join(select(pb, period, oplottype, pb_prop_ma, censusdate)) %>%
  mutate(Treatment = ifelse(oplottype == "CC", "Control", "Exclosure"),
         Rodents = "C. baileyi") %>%
  rename(rod_prop_ma = pb_prop_ma)


pb_title <- expression(paste(bold("D. "), italic("C. baileyi"), " biomass"))

pbplot <- ggplot(pb_glm_nointeraction_se, aes(censusdate, est, color = Treatment, fill = Treatment)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax= upper), alpha = .3) +
  geom_line(aes(y = rod_prop_ma)) +
  ylab(bquote(CB / Btot)) +
  ggtitle(pb_title) +
  theme(legend.position = c(.15, .75)) + 
  both_scale + 
  both_fscale +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = 0, yend = 1), linetype = 3, inherit.aes = F) +
  theme(axis.title.y = element_text(size =  7), 
        legend.title = element_blank(), 
        legend.text = element_text(size =6), 
        legend.key.size = unit(.1, units = "in"), 
        title = element_text(size = 7), 
        legend.background = element_blank(), 
        legend.direction = "vertical", 
        axis.text = element_text(size = 6)) +   
  xlab("Date")  



```



```{r}

dipo_glm <- glm(dipo_prop ~ oera, family = binomial(), data= dipo_c_dat)

dipo_glm_se <- est_glm_ilink(dipo_glm, dipo_c_dat) %>%
  left_join(select(dipo_c_dat, period, dipo_prop_ma)) %>%
  mutate(Treatment = ifelse(oplottype == "CC", "Control", "Exclosure"),
         Rodents = "All small granivores\n(non-Dipodomys)") %>%
  rename(rod_prop_ma = dipo_prop_ma)
dipo_title <- expression(paste(bold("C."), " Kangaroo rat (", italic("Dipodomys"), ") biomass"))


dplot <- ggplot(filter(dipo_glm_se, oplottype == "CC"), aes(censusdate, est)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax= upper), alpha = .3) +
  geom_line(aes(y = rod_prop_ma)) +
  ylab(bquote(KR[C] / Btot[C])) +
  xlab("") +
  ggtitle(dipo_title) +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = 0, yend = 1), linetype = 3, inherit.aes = F) +
  theme(axis.title.y = element_text(size =  7), title = element_text(size = 7), axis.text = element_text(size = 6))


```

# Appendix S3 Figure S1 - Biomass

```{r, fig.dim = c(4,6)}

all_panels <- multi_panel_figure(columns = 1, rows =4, row_spacing = 0, panel_label_type = "none") %>%
  fill_panel(totale_plot) %>%
  fill_panel(comp_plot) %>%
  fill_panel(dplot) %>%
  fill_panel(pbplot)

all_panels

```

\newpage

## Legend

Lines are 6-month moving averages. Horizontal lines + ribbons are means and SE or CL from GLM or GLS.
**Compensation** refers to compensatory gains in biomass by small granivores on exclosure plots relative to controls. Calculated as $\frac{SmgranExclosure - SmgranControl}{DipoControl}$. **Total biomass** refers to the overall loss in biomass caused by kangaroo rat removal.


\newpage

# Model results - Biomass

# Compensation


### Table S1. Coefficients from GLS for compensation

```{r}
compensation_coef <- as.data.frame(summary(comp_mean_gls)$tTable)
compensation_coef
```


### Table S2. Estimates from GLS for compensation 

```{r}

compensation_estimates <- as.data.frame(comp_mean_gls_emmeans)
compensation_estimates

```

### Table S3. Contrasts from GLS for compensation 

```{r}
compensation_contrasts <- as.data.frame(pairs(comp_mean_gls_emmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
compensation_contrasts

```

\newpage

# Total biomass

### Table S4. Coefficients from GLS on total biomass ratio

```{r}

te_coef <- as.data.frame(summary(totale_mean_gls)$tTable)

te_coef

```


### Table S5. Estimates from GLS on total biomass ratio

```{r}

totale_estimates <- as.data.frame(totale_mean_gls_emmeans)
totale_estimates

```


### Table S6. Contrasts from GLS on total biomass ratio

```{r}
totale_contrasts <- as.data.frame(pairs(totale_mean_gls_emmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
totale_contrasts

```


\newpage
# Kangaroo rat proportional biomass


### Table S7. Coefficients from GLM on Dipodomys biomass.

```{r}

dipo_coef <- as.data.frame(summary(dipo_glm)$coefficients)
dipo_coef

```


### Table S8. Estimates from GLM on Dipodomys biomass.

```{r}


dipoemmeans <- regrid(emmeans(dipo_glm, specs = ~ oera))

dipoestimates <- as.data.frame(dipoemmeans)

dipoestimates

```


### Table S9. Contrasts from GLM on Dipodomys biomass.

```{r}
dipocontrasts <- as.data.frame(pairs(dipoemmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
dipocontrasts

```

\newpage
# C. baileyi proportional biomass


```{r, echo = F}

 pb_glm_nointeraction <- glm(pb_prop ~ oera + oplottype, family = binomial(), data= pb_nozero)


```


### Table S10. Coefficients from GLM on C. baileyi biomass

```{r}

pb_coef <- as.data.frame(summary(pb_glm_nointeraction)$coefficients)
pb_coef

```


### Table S11. Estimates from GLM on C. baileyi biomass

```{r}

pb_emmeans <- regrid(emmeans(pb_glm_nointeraction, specs = ~ oera))

pb_estimates <- as.data.frame(pb_emmeans)

pb_estimates

```

### Table S12. Contrasts from GLM on C. baileyi biomass.

```{r}
pb_contrasts <- as.data.frame(pairs(pb_emmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
pb_contrasts

```
