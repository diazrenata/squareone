---
title: "Appendix S1 - Plot-level analysis"
subtitle: "Supplemental information for Diaz and Ernest, “Maintenance of community function through compensation breaks down over time in a desert rodent community”. In review at Ecology."
author: "Fully annotated code and RMarkdown documents to reproduce these analyses are available at https://doi.org/10.5281/zenodo.5544362 and https://doi.org/10.5281/zenodo.5539881."
output:
  # html_document:
  #   toc: yes
  #   df_print: paged
  word_document:
    df_print: kable
    reference_docx: default_gdoc.docx
    toc: yes
  # pdf_document:
  #   toc: yes
  #   df_print: kable
---

```{r setup, include=T, echo = F, results = F, warning = F, message = F}
knitr::opts_chunk$set(echo = F,  warning = F, message = F)

library(soar)
library(ggplot2)
library(dplyr)
library(multipanelfigure)
library(nlme)
library(emmeans)

theme_set(theme_bw())


# Get data using `portalr`:
#treatl <- get_treatment_means() 
# Alternatively, read data from `data/`:
# treatl <- read.csv(here::here("data", "treatl.csv"), stringsAsFactors = T)

# This section is new. Load data using `get_plot_totals` so that you can remove an exclosure plot (resulting in a balanced set of 4 exclosures and 4 controls)

plotl <- get_plot_totals()

plot_types <- list_plot_types() %>% filter(plot_type == "EE")

set.seed(1977) # 1977 is my usual Portal seed
remove_plot <- sample(plot_types$plot, 1, F)

plotl <- plotl %>%
  filter(plot != remove_plot)


# For interpretability, translating the era and treatment "names" as RMD coded them for analysis to the corresponding dates:


oera_df <- data.frame(
  oera = c("a_pre_pb", "b_pre_reorg", "c_post_reorg"),
  `Timeperiod` = c("1988-1997", "1997-2010", "2010-2020")
)

oplot_df <- data.frame(
  oplottype = c("CC", "EE"),
  `Treatment` = c("Control", "Exclosure")
)

contrasts_df <- data.frame(
  contrast = c("a_pre_pb - b_pre_reorg", "a_pre_pb - c_post_reorg", "b_pre_reorg - c_post_reorg"),
  Comparison = c("1988-1997 - 1997-2010", "1988-1997 - 2010-2020", "1997-2010 - 2010-2020")
)

```

\newpage

# Explanation

In order to  calculate energetic compensation and the total energy ratio, we require an estimate for the baseline values of total energy use, kangaroo rat energy use, and small granivore energy use on control plots. Estimating these baselines requires aggregating over between-plot variability among the control plots. For consistency, in the main analysis, we also aggregate across the exclosure plots and focus on treatment-level means throughout. Here, we explore the effect of between-plot variability on our analyses, to the extent possible. 
We used treatment-level means across control plots to calculate energetic compensation and the total energy ratio, but calculated these quantities separately for each exclosure plot, and conducted analyses including a random effect of plot. We also conducted analyses of *Dipodomys* and *C. baileyi* proportional energy use using plot-level data, again including plot as a random effect. Results were qualitatively the same as using treatment-level means. 

<!-- # Calculations of compensation and the total energy ratio -->

```{r, echo = F}

control_means <- plotl %>%
  filter(plot_type == "CC") %>%
  group_by(period) %>%
  summarize(mean_total_e = mean(total_e),
            mean_dipo_e = mean(dipo_e),
            mean_smgran_e = mean(smgran_e)) %>%
  ungroup() 

plotl_vars <- plotl %>%
  left_join(control_means) %>%
  mutate(energy_ratio = total_e / mean_total_e,
         compensation = (smgran_e - mean_smgran_e) / mean_dipo_e,
         dipo_ratio = dipo_e / total_e,
         pb_ratio = pb_e / total_e) %>%
  filter(plot != remove_plot)

compensation_dat <- filter(plotl_vars, oplottype == "EE")
total_e_dat <- filter(plotl_vars, oplottype == "EE")
pb_dat <- filter(plotl_vars, as.numeric(oera) > 1)
dipo_c_dat <- filter(plotl_vars, oplottype == "CC")
```

\newpage

# Compensation

## Model specification and selection


We fit linear mixed-effects models (using the `lme` function in the R package `nlme`; Pinheiro et al. 2021) of the form `compensation ~ time period` with a random effect of plot and temporal autocorrelation structure to account for autocorrelation between monthly census periods within each time period. We compared these to models without the autocorrelation structure, without the random effect, and without the term for time period. The best-fitting model included terms for time period, random effect of plot, and autocorrelation.


### Table S1. Model comparison for compensation.


```{r, echo = F}

# Full model:
comp_plot_gls <- lme(compensation ~ oera , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = compensation_dat)

# No autocorrelation term:
comp_plot_gls_noautoc <- lme(compensation ~ oera , random = ~1|fplot, data = compensation_dat)

# No random effect of plot:
comp_plot_gls_norandom <- gls(compensation ~ oera , correlation = corCAR1(form = ~ period | fplot), data = compensation_dat)

# No term for time period:
comp_plot_gls_notime <- lme(compensation ~ 1 , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = compensation_dat)

# No term for time period, or autocorrelation term:
comp_plot_gls_notime_nocor <- lme(compensation ~ 1 , random = ~1|fplot, data = compensation_dat)

# No terms - intercept-only null model:
comp_plot_gls_notime_nocor_norand <- gls(compensation ~ 1 , data = compensation_dat)


compensation_comparison<- data.frame(
  `Model specification` = c("intercept + timeperiod + plot (random effect) + autocorrelation",
                            "intercept + timeperiod + plot (random effect)",
                            "intercept + timeperiod + autocorrelation" ,
                            "intercept + plot (random effect) + autocorrelation",
                            "intercept + plot (random effect)",
                            "intercept"),
  AIC = c(AIC(comp_plot_gls),
          AIC(comp_plot_gls_noautoc),
          AIC(comp_plot_gls_norandom),
          AIC(comp_plot_gls_notime),
          AIC(comp_plot_gls_notime_nocor),
          AIC(comp_plot_gls_notime_nocor_norand))
)


compensation_comparison

```


```{r, echo = F}
comp_mean_gls_emmeans <- emmeans(comp_plot_gls, specs = ~ oera)

```


## Results

### Table S2. Coefficients from linear mixed-effects model for compensation

Note that "oera" is the variable name for the term for time period in these analyses. 


```{r}
compensation_coef <- as.data.frame(summary(comp_plot_gls)$tTable)
compensation_coef
```


### Table S3. Estimates from linear mixed-effects model for compensation 

```{r}

compensation_estimates <- oera_df %>% 
  left_join(as.data.frame(comp_mean_gls_emmeans)) %>%
  select(-oera)
compensation_estimates

```

### Table S4. Contrasts from linear mixed-effects model for compensation 

```{r}
compensation_contrasts <- contrasts_df %>% 
  left_join(as.data.frame(pairs(comp_mean_gls_emmeans))) %>%
  select(-contrast) %>%
  mutate(p.value = round(p.value, digits = 4))
compensation_contrasts

```
\newpage

# Total energy use

## Model specification and selection


As for compensation, we fit linear mixed-effects models fitting *total_energy_ratio ~ time period* with a random effect of plot and a temporal autocorrelation term to account for autocorrelation between monthly census periods within each timeperiod. We compared these to models without the autocorrelation term, without the random effect, and without the term for time period. The best-fitting model included terms for time period, random effect of plot, and autocorrelation.


### Table S5. Model comparison for total energy ratio.
```{r, echo = F}

totale_plot_gls <- lme(energy_ratio~ oera , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = total_e_dat)

totale_plot_gls_noautoc <- lme(energy_ratio~ oera , random = ~1|fplot, data = total_e_dat)

totale_plot_gls_norandom <- gls(energy_ratio~ oera , correlation = corCAR1(form = ~ period | fplot), data = total_e_dat)


totale_plot_gls_notime <- lme(energy_ratio~ 1 , random = ~1|fplot,  correlation = corCAR1(form = ~ period | fplot), data = total_e_dat)
totale_plot_gls_notime_nocor <- lme(energy_ratio~ 1 , random = ~1|fplot, data = total_e_dat)
totale_plot_gls_notime_nocor_norand <- gls(energy_ratio~ 1 , data = total_e_dat)


te_comparison<- data.frame(
  `Model specification` = c("intercept + timeperiod + plot (random effect) + autocorrelation",
                            "intercept + timeperiod + plot (random effect)",
                            "intercept + timeperiod + autocorrelation" ,
                            "intercept + plot (random effect) + autocorrelation",
                            "intercept + plot (random effect)",
                            "intercept"),
  AIC = c(AIC(totale_plot_gls),
          AIC(totale_plot_gls_noautoc),
          AIC(totale_plot_gls_norandom),
          AIC(totale_plot_gls_notime),
          AIC(totale_plot_gls_notime_nocor),
          AIC(totale_plot_gls_notime_nocor_norand))
)


te_comparison

```



```{r, echo = F}
totale_mean_gls_emmeans <- emmeans(totale_plot_gls, specs = ~ oera)

```


## Results
### Table S6. Coefficients from linear mixed-effects model on total energy ratio

Note that "oera" is the variable name for the term for time period in these analyses. 


```{r}

te_coef <- as.data.frame(summary(totale_plot_gls)$tTable)

te_coef

```


### Table S7. Estimates from linear mixed-effects model on total energy ratio

```{r}

totale_estimates <- oera_df %>%
  left_join(as.data.frame(totale_mean_gls_emmeans)) %>%
  select(-oera)
totale_estimates

```


### Table S8. Contrasts from linear mixed-effects model on total energy ratio

```{r}
totale_contrasts <- contrasts_df %>% left_join(as.data.frame(pairs(totale_mean_gls_emmeans))) %>%
  select(-contrast) #%>%
#mutate(p.value = round(p.value, digits = 5))
totale_contrasts

```

\newpage

# Kangaroo rat proportional energy use

## Model specification and selection

To compare proportional energy use across time periods, we used binomial generalized linear mixed models (using the `glmer` function in the R package `lme4`; Bates et al. 2015), which allowed us to include a random effect of plot. 

For *Dipodomys* proportional energy use, we compared models with and without the random effect of plot and with and without a term for timeperiod. The best-fitting model included terms for timeperiod and a random effect of plot.


### Table S9. Model comparison for Dipodomys proportional energy use.

```{r, echo = F}
library(lme4)

dipo_glmer <- glmer(dipo_ratio ~ oera + (1|fplot), data = dipo_c_dat, family = binomial)
dipo_glm <- glm(dipo_ratio ~ oera, data = dipo_c_dat, family = binomial)
dipo_int_glmer <- glmer(dipo_ratio ~ 1 + (1|fplot), data = dipo_c_dat, family = binomial)
dipo_int_glm <- glm(dipo_ratio ~ 1, data = dipo_c_dat, family = binomial)

dipo_comparison<- data.frame(
  `Model specification` = c("intercept + timeperiod + plot (random effect)",
                            "intercept + plot (random effect)",
                            "intercept + timeperiod",
                            "intercept"),
  AIC = c(AIC(dipo_glmer),
          AIC(dipo_int_glmer),
          AIC(dipo_glm),
          AIC(dipo_int_glm)
  ))

dipo_comparison

```

## Results
### Table S10. Coefficients from GLMER on Dipodomys energy use.


Note that "oera" is the variable name for the term for time period in these analyses. 


```{r}

dipo_coef <- as.data.frame(summary(dipo_glmer)$coefficients)
dipo_coef

```


### Table S11. Estimates from GLMER on Dipodomys energy use.

Note that estimates are back-transformed onto the response scale, for interpretability.


```{r}


dipoemmeans <- regrid(emmeans(dipo_glmer, specs = ~ oera))

dipoestimates <- oera_df %>%
  left_join(as.data.frame(dipoemmeans)) %>%
  select(-oera)

dipoestimates

```


### Table S12. Contrasts from GLMER on Dipodomys energy use.

Contrasts are performed on the link (logit) scale.


```{r}
dipocontrasts <- contrasts_df %>%
  left_join(as.data.frame(pairs(dipoemmeans))) %>%
  select(-contrast) %>%
  mutate(p.value = round(p.value, digits = 4))
dipocontrasts

```

\newpage

# C. baileyi proportional energy use

## Model specification and selection


As for kangaroo rat proportional energy use, we used a binomial generalized linear mixed effects model to compare *C. baileyi* proportional energy use across time periods. Because *C. baileyi* occurs on both control and exclosure plots, we investigated whether the dynamics of *C. baileyi*'s proportional energy use differed between treatment types. We compared models incorporating separate slopes, separate intercepts, or no terms for treatment modulating the change in *C. baileyi* proportional energy use across time periods, i.e. comparing the full set of models:

- *cbaileyi_proportional_energy_use ~ timeperiod + treatment + timeperiod:treatment*
- *cbaileyi_proportional_energy_use ~ timeperiod + treatment*
- *cbaileyi_proportional_energy_use ~ timeperiod*

We also tested a null (intercept-only) model of no change across time periods:

- *cbaileyi_proportional_energy_use ~ 1*

We compared all of these models with and without a random effect of plot.

We found that the best-fitting model incorporated a random effect of plot, and fixed effects for time period and for treatment, but no interaction between them (*cbaileyi_proportional_energy_use ~ timeperiod + treatment*). We therefore proceeded with this model. 

### Table S13. Model comparison for C. baileyi proportional energy use.

```{r, echo = F}

pb_glmer_interaction <- glmer(pb_ratio ~ oera * oplottype + (1|fplot), data = pb_dat, family = binomial)
pb_glmer_nointeraction <- glmer(pb_ratio ~ oera + oplottype + (1|fplot), data = pb_dat, family = binomial)
pb_glmer_notreat <- glmer(pb_ratio ~ oera + (1|fplot), data = pb_dat, family = binomial)
pb_glmer_notime <- glmer(pb_ratio ~ 1 + (1|fplot), data = pb_dat, family = binomial)

pb_glm_interaction <- glm(pb_ratio ~ oera * oplottype , data = pb_dat, family = binomial)
pb_glm_nointeraction <- glm(pb_ratio ~ oera + oplottype , data = pb_dat, family = binomial)
pb_glm_notreat <- glm(pb_ratio ~ oera, data = pb_dat, family = binomial)
pb_glm_notime <- glm(pb_ratio ~ 1, data = pb_dat, family = binomial)


pb_comparison <- data.frame(
  `Model specification` = c("intercept + timeperiod + treatment + timeperiod:treatment + plot (random effect)",
                            "intercept + timeperiod + treatment + plot (random effect)",
                            "intercept + timeperiod + plot (random effect)",
                            "intercept + plot (random effect)",
                            "intercept + timeperiod + treatment + timeperiod:treatment",
                            "intercept + timeperiod + treatment",
                            "intercept + timeperiod",
                            "intercept"),
  AIC = c(AIC(pb_glmer_interaction),
          AIC(pb_glmer_nointeraction),
          AIC(pb_glmer_notreat),
          AIC(pb_glmer_notime),
          AIC(pb_glm_interaction),
          AIC(pb_glm_nointeraction),
          AIC(pb_glm_notreat),
          AIC(pb_glm_notime))
)

pb_comparison
```


## Results

### Table S14. Coefficients from GLMER on C. baileyi energy use

Note that "oera" is the variable name for the term for time period in these analyses, and "oplottype" refers to experimental treatment. 


```{r}

pb_coef <- as.data.frame(summary(pb_glmer_nointeraction)$coefficients)
pb_coef

```


### Table S15. Estimates from GLMER on C. baileyi energy use

Note that estimates are back-transformed onto the response scale, for interpretability.

```{r}

pb_emmeans <- (emmeans(pb_glmer_nointeraction, specs = ~ oera | oplottype))

pb_estimates <- oera_df %>% 
  right_join(as.data.frame(regrid(pb_emmeans))) %>%
  left_join(oplot_df) %>%
  select(Timeperiod, Treatment, prob, SE, df, asymp.LCL, asymp.UCL)

pb_estimates


```

### Table S16. Contrasts from GLMER on C. baileyi energy use.

Contrasts are performed on the link (logit) scale.


```{r}
pb_contrasts <- contrasts_df %>%
  right_join(as.data.frame(pairs(pb_emmeans))) %>%
  left_join(oplot_df) %>%
  mutate(p.value = round(p.value, digits = 4)) %>%
  select(Comparison, Treatment, estimate, SE, df, z.ratio, p.value)
pb_contrasts

```

\newpage

# References

Bates, Douglas, Martin Maechler, Ben Bolker, Steve Walker (2015). _Fitting Linear Mixed-Effects Models Using lme4._ Journal of Statistical Software, 67(1), 1-48. doi:10.18637/jss.v067.i01.

Lenth,  Russell V. (2021). emmeans: _Estimated Marginal Means, aka Least-Squares Means._ R package version 1.7.0. <URL: https://CRAN.R-project.org/package=emmeans>

Pinheiro J, Bates D, DebRoy S, Sarkar D, R Core Team (2021). _nlme: Linear and Nonlinear Mixed Effects Models_. R package version 3.1-153, <URL: https://CRAN.R-project.org/package=nlme>.