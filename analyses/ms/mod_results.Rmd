---
title: "Complete model results"
output: 
  word_document:
       df_print: kable
       reference_docx: style_reference.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, fig.dim = c(6, 3))
library(soar)
library(ggplot2)
library(dplyr)
library(mgcv)
library(gratia)
theme_set(theme_bw())

library(nlme)
library(emmeans)
treatl <- get_treatment_means() %>%
  remove_switch()

pb <- get_pb(treatl)
pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)


smgran_dat <- treatl %>%
  mutate(smgran_prop = smgran_e / total_e) %>%
  group_by(oplottype) %>%
  mutate(smgran_prop_ma = maopts(smgran_prop)) %>%
  ungroup()


energy_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)


erodium_treatments <- get_erodium_treatment()

erodium_treatments <- erodium_treatments %>%
  mutate(era = ifelse(year <= 1997, "a_pre_pb", ifelse(year < 2010, "b_pre_reorg", "c_post_reorg"))) %>%
  rename(plot_type = combined_trt)  %>%
  mutate(oplottype= as.ordered(plot_type),
         oera = as.ordered(era))

erodium_treatments_noz <- filter(erodium_treatments, total_total_abundance > 0)

```

# 1. Versions


All analyses were conducted in R version 4.0.3 on a MacBook Air running macOS Catalina 10.15.7. Key statistical packages used are nlme 3.1-149 (Pinheiro et al. 2020) and emmeans 1.5.4 (Lenth 2021).


# 2. Energetic compensation GLS

Compensation is calculated as `(SmallGranivoreEnergy_Exclosures - SmallGranivoreEnergy_Controls) / KangarooRatEnergy_Controls` for each census period.

Model call:

```{r, echo = T}

comp_gls <- gls(smgran_comp ~ era,  correlation = corCAR1(form = ~ period), data = compensation)

```

`period` refers to the census period.


## Significance of terms

Following https://stats.stackexchange.com/questions/13859/finding-overall-p-value-for-gls-model, we compare a version of the model with no fixed effect to the above model. The two models are separated by 1 degree of freedom. 

```{r}

corValue <- intervals(comp_gls)$corStruct[2]

comp_int_gls <- gls(smgran_comp ~ 1, correlation = corCAR1(form = ~period, value = corValue, fixed = TRUE), data = compensation)

comp_gls_ml <- update(comp_gls, . ~ ., method = "ML")

comp_int_gls_ml <- update(comp_int_gls, . ~ ., method = "ML")

anova_table <- anova(comp_gls_ml, comp_int_gls_ml)

likR <- anova_table$L.Ratio[2]

# Likelihood ratio:

likR
```

```{r}
# P value for the time period (era) effect:

pchisq(likR, 1, lower.tail = F)

```


## Contrasts

```{r}
comp_gls_emmeans <- emmeans(comp_gls, specs = ~ era)

comp_pairs <- as.data.frame(pairs(comp_gls_emmeans))

comp_pairs
```

## Estimates

```{r}

comp_estimates <- as.data.frame(comp_gls_emmeans)

comp_estimates
```

# 3. Total energy ratio GLS

The ratio of total energy use on exclosure plots relative to controls, calculated for each census period.

Model call:

```{r, echo = T}

totale_gls <- gls(total_e_rat ~  era,  correlation = corCAR1(form = ~ period), data = energy_ratio)

```


## Significance of effects


```{r}

corValue <- intervals(totale_gls)$corStruct[2]

totale_int_gls <- gls(total_e_rat ~ 1, correlation = corCAR1(form = ~period, value = corValue, fixed = TRUE), data = energy_ratio)

totale_gls_ml <- update(totale_gls, . ~ ., method = "ML")

totale_int_gls_ml <- update(totale_int_gls, . ~ ., method = "ML")

anova_table <- anova(totale_gls_ml, totale_int_gls_ml)

likR <- anova_table$L.Ratio[2]

# Likelihood ratio:

likR
```

```{r}
# P value for the time period (era) effect:

pchisq(likR, 1, lower.tail = F)

```


## Contrasts

```{r}


totale_gls_emmeans <- emmeans(totale_gls, specs = ~ era)

totale_contrasts <- as.data.frame(pairs(totale_gls_emmeans))

totale_contrasts

```

## Estimates

```{r}

totale_pred <- as.data.frame(totale_gls_emmeans)

totale_pred


```

# 4. Small granivore proportional energy use GLM


Energy use by small granivores as a proportion of treatment-level energy use in each census period.


Model call:

```{r}

smgran_glm <- glm(smgran_prop ~ oera * oplottype, family = quasibinomial(), data= smgran_dat)

```


`oera` is the time period, and `oplottype` is treatment. 

```{r}

summary(smgran_glm)

```

<!-- ## Significance of effects -->


<!-- ```{r} -->
<!-- smgran_nointeraction_glm<- glm(smgran_prop ~ oera + oplottype, family = quasibinomial(), data= smgran_dat) -->


<!-- smgran_era_glm<- glm(smgran_prop ~ oera, family = quasibinomial(), data= smgran_dat) -->

<!-- smgran_time_glm<- glm(smgran_prop ~ oera, family = quasibinomial(), data= smgran_dat) -->

<!-- smgran_intercept_glm<- glm(smgran_prop ~ 1, family = quasibinomial(), data= smgran_dat) -->


<!-- (anova(smgran_glm, smgran_nointeraction_glm, test = "Chisq")) -->

<!-- (anova(smgran_glm, smgran_era_glm, test = "Chisq")) -->

<!-- (anova(smgran_glm, smgran_time_glm, test = "Chisq")) -->

<!-- (anova(smgran_glm, smgran_intercept_glm, test = "Chisq")) -->


<!-- ``` -->

## Contrasts

```{r}


smgran_emmeans <- (emmeans(smgran_glm, specs = ~ oera | oplottype))

smgran_contrasts <- as.data.frame(pairs(smgran_emmeans))
smgran_contrasts


```


## Estimates 

Estimates from `emmeans` differ numerically (in the far decimals) from estimates obtained via `predict()` and back transformation. Below are estimates from `emmeans`, because those are what are used for contrasts. Estimates given on the response (not link) scale.

```{r}

smgran_estimates <- as.data.frame(regrid(smgran_emmeans))

smgran_estimates

```



Estimates from `predict`:

```{r}

smgran_glm_se <- est_glm_ilink(smgran_glm, smgran_dat) %>%
  dplyr::select(-period, -censusdate) %>%
  dplyr::distinct()
smgran_glm_se
```

# 5. C baileyi proportional abundance GLM


Energy use by _C. baileyi_ as a proportion of treatment-level energy use in each census period. Because _C. baileyi_ was absent from 1977-1996, restricted to the second two time periods (July 1997-2020)


Model call:

```{r}

pb_glm <- glm(pb_prop ~ oera * oplottype, family = quasibinomial(), data= pb_nozero)

```


`oera` is the time period, and `oplottype` is treatment. 


```{r}

summary(pb_glm)

```

<!-- ## Significance of effects -->


<!-- ```{r} -->
<!-- pb_nointeraction_glm<- glm(pb_prop ~ oera + oplottype, family = quasibinomial(), data= pb_nozero) -->


<!-- pb_era_glm<- glm(pb_prop ~ oera, family = quasibinomial(), data= pb_nozero) -->

<!-- pb_time_glm<- glm(pb_prop ~ oera, family = quasibinomial(), data= pb_nozero) -->

<!-- pb_intercept_glm<- glm(pb_prop ~ 1, family = quasibinomial(), data= pb_nozero) -->


<!-- (anova(pb_glm, pb_nointeraction_glm, test = "Chisq")) -->

<!-- (anova(pb_glm, pb_era_glm, test = "Chisq")) -->

<!-- (anova(pb_glm, pb_time_glm, test = "Chisq")) -->

<!-- (anova(pb_glm, pb_intercept_glm, test = "Chisq")) -->


<!-- ``` -->

## Contrasts

```{r}


pb_emmeans <- (emmeans(pb_glm, specs = ~ oera | oplottype))

pb_contrasts <- as.data.frame(pairs(pb_emmeans))
pb_contrasts


```


## Estimates 

Estimates from `emmeans` differ numerically (in the far decimals) from estimates obtained via `predict()` and back transformation. Below are estimates from `emmeans`, because those are what are used for contrasts. Estimates given on the response (not link) scale.

```{r}

pb_estimates <- as.data.frame(regrid(pb_emmeans))

pb_estimates

```



Estimates from `predict`:

```{r}

pb_glm_se <- est_glm_ilink(pb_glm, pb_nozero) %>%
  dplyr::select(-period, -censusdate) %>%
  dplyr::distinct()
pb_glm_se
```

# 6. E. ciculatum proportional abundance GLM

_E. ciculatum_ abundance as a proportion of total plant abundance for each winter census. 

Model call - note that an interaction between plot type and era is not significant, so we drop it:

```{r}


erod_glm <- glm(erod_treatment_prop_abundance ~ oplottype * oera, data = erodium_treatments_noz, family = quasibinomial())

summary(erod_glm)

erod_glm_nointeraction <-  glm(erod_treatment_prop_abundance ~ oplottype + oera, data = erodium_treatments_noz, family = quasibinomial())

(anova(erod_glm, erod_glm_nointeraction, test = "Chisq"))

summary(erod_glm_nointeraction)
```


## Contrasts

```{r}


erod_emmeans <- (emmeans(erod_glm_nointeraction, specs = ~ oera | oplottype))

erod_contrasts <- as.data.frame(pairs(erod_emmeans))

erod_contrasts


```


## Estimates 

Estimates from `emmeans` differ numerically (in the far decimals) from estimates obtained via `predict()` and back transformation. Below are estimates from `emmeans`, because those are what are used for contrasts. Estimates given on the response (not link) scale.

```{r}

erod_estimates <- as.data.frame(regrid(erod_emmeans))

erod_estimates

```

Estimates from `predict`:

```{r}

erod_glm_se <- est_glm_ilink(erod_glm, mutate(erodium_treatments_noz, period = year, censusdate = year)) %>%
  dplyr::select(-period, -censusdate) %>%
  dplyr::distinct()
erod_glm_se
```