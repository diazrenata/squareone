---
title: "Figures for main text"
output: #word_document
   # github_document:
   #      df_print: kable
   #      toc: true
   pdf_document 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.dim = c(6, 3))
library(soar)
library(ggplot2)
library(dplyr)
library(multipanelfigure)
library(nlme)
library(emmeans)

# Get data using `portalr`:
#treatl <- get_treatment_means() 
# Alternatively, read data from `data/`:
# treatl <- read.csv(here::here("data", "treatl.csv"), stringsAsFactors = T)

# This section is new. Load data using `get_plot_totals` so that you can remove an exclosure plot (resulting in a balanced set of 4 exclosures and 4 controls)

plotl <- get_plot_totals()

plot_types <- list_plot_types() %>% filter(plot_type == "EE")

set.seed(1977) # 1977 is my usual Portal seed
remove_plot <- sample(plot_types$plot, 1, F)

plotl <- plotl %>%
  filter(plot != remove_plot)

treatl <- plots_to_treatment_means(plotl) 

 treatl <- treatl %>%
   mutate(censusdate = as.Date(censusdate),
          oera = ordered(oera),
          oplottype = ordered(oplottype))
 
pb <- get_pb(treatl) 

pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)
energy_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)


# For figures:

theme_set(theme_bw())

both_scale <- scale_color_viridis_d(option = "cividis", begin = .1, end = .8, direction = -1)
both_fscale <- scale_fill_viridis_d(option = "cividis", begin = .1, end = .8, direction = -1)

#era_df <- make_era_df()
# Alternatively, get the era_df from `data/`:
era_df <- read.csv(here::here("data", "era_df.csv"))
era_df <- era_df %>%
  mutate(event_date = as.Date(event_date),
         no_name = "")

```

# Figures

## Compensation and total energy use


Lines are 6-month moving averages. Horizontal lines + ribbons are means and SE or CL from GLM or GLS.

### Compensation

**Compensation** refers to compensatory gains in energy use by small granivores on exclosure plots relative to controls. Calculated as $\frac{SmgranExclosure - SmgranControl}{DipoControl}$. **Total energy** refers to the overall loss in energy use caused by kangaroo rat removal.

```{r}


comp_mean_gls <- gls(smgran_comp ~ oera,  correlation = corCAR1(form = ~ period), data = compensation)

comp_mean_gls_emmeans <- emmeans(comp_mean_gls, specs = ~ oera)

comp_mean_pred <-  as.data.frame(comp_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(compensation)

comp_plot <- ggplot(filter(comp_mean_pred, oplottype %in% c("CC", "EE")), aes(censusdate, emmean)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL), alpha = .2) +
  geom_line(aes(y = smgran_comp_ma)) +
  ggtitle("Energetic compensation") +
  ylab(bquote(frac(SG[E] - SG[C], KR[C]))) +
  #ylim(-.05, 1) +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = -.05, yend = 1), linetype = 3)+
  xlab("") +
  scale_x_date(sec.axis = dup_axis(name = NULL, breaks = era_df$event_date, labels = era_df$no_name)) +
  theme(axis.title.y = element_text(size =  10), axis.text = element_text(size = 10)) + xlab("")

comp_plot
```

### Total energy ratio

```{r}

totale_mean_gls <- gls(total_e_rat ~  oera,  correlation = corCAR1(form = ~ period), data = energy_ratio)


totale_mean_gls_emmeans <- emmeans(totale_mean_gls, specs = ~ oera)


totale_mean_pred <- as.data.frame(totale_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(energy_ratio)
  
totale_plot <- ggplot(filter(totale_mean_pred, oplottype %in% c("CC", "EE")), aes(censusdate, emmean)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower.CL, ymax = upper.CL), alpha = .2) +
  geom_line(aes(y = total_e_rat_ma)) +
  ggtitle("Total energy use") +
  ylab(bquote(frac(Etot[E], Etot[C]))) +
  theme(legend.position = "none") +
  ylim(-0, 1.2) +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = 0, yend = 1.2), linetype = 3) +
  scale_x_date(sec.axis = dup_axis(name = NULL, breaks = era_df$event_date, labels = era_df$event_name))+
  theme(axis.title.y = element_text(size =  10),  axis.text = element_text(size = 10)) + xlab("")

totale_plot

```

## Rodent community composition

### C. baileyi


```{r}



pb_glm_interaction <- glm(pb_prop ~ oera * oplottype, family = binomial(), data= pb_nozero)
pb_glm_nointeraction <- glm(pb_prop ~ oera + oplottype, family = binomial(), data= pb_nozero)
pb_glm_notreat <- glm(pb_prop ~ oera, family = binomial(), data= pb_nozero)


pb_glm_nointeraction_se <- est_glm_ilink(pb_glm_nointeraction, pb_nozero) %>%
  full_join(select(pb, period, oplottype, pb_prop_ma, censusdate)) %>%
  mutate(Treatment = ifelse(oplottype == "CC", "Control", "Exclosure"),
         Rodents = "C. baileyi") %>%
  rename(rod_prop_ma = pb_prop_ma)

pb_title <- expression(paste(italic("C. baileyi"), " energy use"))

pbplot <- ggplot(pb_glm_nointeraction_se, aes(censusdate, est, color = Treatment, fill = Treatment)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax= upper), alpha = .3) +
  geom_line(aes(y = rod_prop_ma)) +
  ylab(bquote(frac(CB, Etot))) +
 ggtitle(pb_title) +
  theme(legend.position = c(.15, .6)) + 
  both_scale + 
  both_fscale   +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = 0, yend = 1), linetype = 3, inherit.aes = F) +
  scale_x_date(sec.axis = dup_axis(name = NULL, breaks = era_df$event_date, labels = era_df$no_name)) + 
  theme(axis.title.y = element_text(size =  10), legend.title = element_blank(), legend.text = element_text(size =8))+ 
  theme( title = element_text(size = 10), legend.background = element_blank(), axis.title.y = element_text(), legend.direction = "vertical", axis.text = element_text(size = 10)) +   xlab("Date")  


pbplot

```


### Dipodomys

```{r}

dipo_dat <- treatl %>%
  mutate(dipo_prop = dipo_e / total_e,
         smgran_prop= smgran_e / total_e) %>%
  group_by(oplottype) %>%
  mutate(smgran_prop_ma = maopts(smgran_prop),
         dipo_prop_ma = maopts(dipo_prop)) %>%
  ungroup() 

dipo_c_dat <- dipo_dat %>%
  filter(oplottype == "CC")

dipo_glm <- glm(dipo_prop ~ oera, family = binomial(), data= dipo_c_dat)

dipo_glm_se <- est_glm_ilink(dipo_glm, dipo_c_dat) %>%
  left_join(select(dipo_c_dat, period, dipo_prop_ma)) %>%
  mutate(Treatment = ifelse(oplottype == "CC", "Control", "Exclosure"),
         Rodents = "All small granivores\n(non-Dipodomys)") %>%
  rename(rod_prop_ma = dipo_prop_ma)
dipo_title <- expression(paste("Kangaroo rat (", italic("Dipodomys"), ") energy use"))


dplot <- ggplot(filter(dipo_glm_se, oplottype == "CC"), aes(censusdate, est)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax= upper), alpha = .3) +
  geom_line(aes(y = rod_prop_ma)) +
  ylab( bquote(frac(KR[C], Etot[C]))) +
  xlab("") +
  ggtitle(dipo_title) +
  #theme(legend.position = c(.15, .6)) + both_scale + both_fscale   +
  geom_segment(data = era_df, aes(x = event_date, xend = event_date, y = 0, yend = 1), linetype = 3, inherit.aes = F) +
  scale_x_date(sec.axis = dup_axis(name = NULL, breaks = era_df$event_date, labels = era_df$no_name)) + xlab("") +
  theme(axis.title.y = element_text(size =  10), legend.title = element_blank(), legend.text = element_text(size =  10))+ theme( title = element_text(size = 10), axis.text = element_text(size = 10), legend.background = element_blank(), legend.direction = "vertical")

dplot

```

## Full figure

```{r, fig.dim = c(6, 9)}

all_panels <- multi_panel_figure(columns = 1, rows =4, row_spacing = 0) %>%
  fill_panel(totale_plot) %>%
  fill_panel(comp_plot) %>%
  fill_panel(dplot) %>%
  fill_panel(pbplot)

all_panels


ggsave("figure_1.pdf", plot = all_panels, device = "pdf", width = 6, height = 9, units = "in", dpi = 800)


```
