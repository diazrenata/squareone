---
title: "Erodium"
output: github_document
---
```{r setup}
library(dplyr)
library(soar)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE, fig.dim = c(6, 3))

theme_set(theme_bw())

era_grid <-   facet_grid(cols = vars(oera), space = "free", scales = "free_x")
both_scale <- scale_color_viridis_d(begin = .1, end = .8)
cc_scale <- scale_color_viridis_d(begin = .1, end = .1)
ee_scale <- scale_color_viridis_d(begin = .8, end =.8)
both_fscale <- scale_fill_viridis_d(begin = .1, end = .8)
cc_fscale <- scale_fill_viridis_d(begin = .1, end = .1)
ee_fscale <- scale_fill_viridis_d(begin = .8, end =.8)


```


```{r}

erodium_treatments <- get_erodium_treatment()

erodium_treatments <- erodium_treatments %>%
  mutate(era = ifelse(year < 1996, "a", ifelse(year < 2010, "b", "c"))) %>%
  mutate(oera = as.ordered(era)) %>%
  mutate(erod_total_abundance_std = 5 * (erod_total_abundance / total_plots)) %>%
rename(plot_type = combined_trt)  %>%
  mutate(oplottype= as.ordered(plot_type))

```

# Treatment levels

Gaps are for censuses in 1996, 2000, 2006, and 2011 where plots were censused but no individuals were found (of any species).

```{r}

ggplot(erodium_treatments, aes(year,erod_treatment_prop_abundance, color = plot_type)) +
  geom_line() +
  facet_wrap(vars(plot_type)) +
  era_grid + both_scale + ggtitle("Erodium proportional abundance", subtitle = "Total erodium abundance / Total abundance over all plots in treatment")



ggplot(erodium_treatments, aes(year, erod_total_abundance_std, color = plot_type)) +
  geom_line() +
  facet_wrap(vars(plot_type)) +
  era_grid + both_scale + ggtitle("Erodium total abundance", subtitle = "Standardized to account for 4 CC, 5 EE plots")

```

```{r}

erodium_treatments_noz <- filter(erodium_treatments, total_total_abundance > 0)

prop_glm <- glm(erod_treatment_prop_abundance ~ oplottype * oera, data = erodium_treatments_noz, family = quasibinomial())

prop_glm_noint <-  glm(erod_treatment_prop_abundance ~ oplottype + oera, data = erodium_treatments_noz, family = quasibinomial())

(anova(prop_glm, prop_glm_noint, test = "Chisq"))



ilink <- prop_glm_noint$family$linkinv

prop_glm_est <- predict(prop_glm_noint, type = "link", se.fit = T, newdata = distinct(select(erodium_treatments_noz, oplottype, oera))) %>%
  as.data.frame() %>%
  dplyr::mutate(est = ilink(fit),
                lower = ilink(fit - 2*se.fit),
                upper = ilink(fit + 2*se.fit),
                oera = distinct(select(erodium_treatments_noz, oplottype, oera))$oera,
                oplottype = distinct(select(erodium_treatments_noz, oplottype, oera))$oplottype) %>%
  right_join(erodium_treatments_noz)

ggplot(prop_glm_est, aes(year, erod_treatment_prop_abundance, color = plot_type, fill = plot_type)) +
  geom_line() +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .1) +
  facet_wrap(vars(plot_type), ncol = 1) +
  both_scale + both_fscale

prop_glm_est %>%
  select(oera, oplottype, est, lower, upper) %>%
  distinct()

glm_emmeans <- emmeans::emmeans(prop_glm_noint, specs = ~ oera | oplottype)

pairs(glm_emmeans)

```

# Plot level

Broken out by plot, we get gaps for years and plots when there were no individuals (of any species) observed:


```{r}
erodium_plot <- get_erodium_plot() %>%
  mutate(plot_type = combined_trt)


ggplot(erodium_plot, aes(year, erod_plot_abundance, color = plot_type, group = plot)) +
  geom_line() + 
  facet_wrap(vars(plot_type)) +
  both_scale



ggplot(erodium_plot, aes(year, erod_plot_prop_abundance, color = plot_type, group = plot)) +
  geom_line() + 
  facet_wrap(vars(plot_type)) +
  both_scale



ggplot(erodium_plot, aes(year, erod_plot_prop_abundance, color = plot_type, group = plot)) +
  geom_line(alpha = .3) + 
  facet_wrap(vars(plot_type)) +
  both_scale +
  geom_line(data = erodium_treatments, aes(year, erod_treatment_prop_abundance, color = plot_type), inherit.aes=F)
```