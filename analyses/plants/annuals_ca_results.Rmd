---
title: "(P)(C)CA on annual plants"
output: 
    github_document:
       df_print: kable
       toc: true
---
```{r setup, include=FALSE}
library(dplyr)
library(soar)
library(ggplot2)
library(vegan)

knitr::opts_chunk$set(echo = FALSE, fig.dim = c(6, 3))

theme_set(theme_bw())

winter_treat_abunds <- get_treatment_abundance_matrix()
summer_treat_abunds <- get_treatment_abundance_matrix("summer")

winter_plot_abunds <- get_plot_abundance_matrix()
summer_plot_abunds <- get_plot_abundance_matrix("summer")


```

# Summary

I am not at expert-level in correspondence analysis, so this is to the best of my understanding. 

With CA, we just try to summarize the variability in the community composition data and then plot each sample (community composition of a plot in a census year) on the first 2 axes. I then colored the points and plotted the centroids of three "eras": a, 1988-96, b, 1996-2010, and c, 2010-2019. The analysis has no idea these are structuring variables of interest. 

The CA plot for winter shows strong temporal structure; in particular, b and c are very different from a (but not really different from each other). The CA for summer shows no such structure.

For the pCCA, we tell the cca function to pay attention to treatment and "era", and condition on the effect of plot (similar to a random effect). Adding these constraints results in greater separation of b and c for the winter annuals, and less - but still huge - overlap for the different eras for the summer annuals. 

The constraints, combined, account for about 20% of variation in winter and 10% in summer. All the constraints (treatment, era, and plot) come up as "significant" in permutation tests.

#### Takeaway

What I take away from this is that:

- The annuals change over time!
- Winter has more temporal structure than summer.
- I am hesitant to interpret this as there being a really pronounced shift in 2010, though. 
    - The plotted axes account for very little of the total variation in the pCCAs (20% for winter, 9% for summer). 
    - I haven't found a way to test contrasts in CCA (e.g. "is b significantly different from c"). 
    - The eras may be arbitrary (with respect to this data) - although trying this with other time chunking strategies gives qualitatively similar answers.

# Winter

## CA

Combined, these two axes account for about 27% of variation. 

```{r}

winter_plot_abund_matrix <- winter_plot_abunds %>%
  ungroup() %>%
  filter(plot_total_abundance >0 ) %>%
  select(-c(year, plot, season, combined_trt, empty_plot, quadrats_censused, plot_total_abundance)) %>%
  mutate_all(sqrt)


winter_plot_ca <- cca(winter_plot_abund_matrix)

#barplot(winter_plot_ca$CA$eig / winter_plot_ca$tot.chi, names.arg = 1:winter_plot_ca$CA$rank, cex.names = 0.5)

(winter_plot_ca$CA$eig / winter_plot_ca$tot.chi)[1:5]


winter_preds <-  winter_plot_abunds %>%
  ungroup() %>%
  filter(plot_total_abundance > 0) %>%
  select((c(plot, year, combined_trt)))%>%
  mutate(rod_era = as.ordered(ifelse(year < 1997, "a",
                                     ifelse(year < 2010, "b",
                                            "c"))))

winter_plot_ca_scores <- as.data.frame(scores(winter_plot_ca, display = "sites", scaling = "sites")) %>%
  cbind(winter_preds)

ggplot(winter_plot_ca_scores, aes(CA1, CA2, color = rod_era)) + 
  geom_point()  +
  stat_ellipse() +
    ylim(-2.5, 1) +
  facet_wrap(vars(combined_trt))
```


<!-- ## CCA -->

<!-- ```{r} -->

<!-- winter_plot_cca <- cca(winter_plot_abund_matrix ~ ., data = select(winter_preds, combined_trt, rod_era)) -->

<!-- summary(winter_plot_cca) -->

<!-- winter_plot_cca_scores <- as.data.frame(scores(winter_plot_cca, display = "sites", scaling = "sites")) %>% -->
<!--   cbind(winter_preds) -->

<!-- ggplot(winter_plot_cca_scores, aes(CCA1, CCA2, color = rod_era)) +  -->
<!--   geom_point()  + -->
<!--   stat_ellipse() + -->
<!--   facet_wrap(vars(combined_trt)) -->

<!-- ``` -->

## pCCA

The constraints account for about 20% of total variation. These two axes account for about 19%. 

```{r}

winter_plot_pcca <- cca(winter_plot_abund_matrix ~  rod_era + combined_trt + Condition(plot), winter_preds)


winter_plot_pcca

(winter_plot_pcca$CCA$eig / winter_plot_pcca$tot.chi)

winter_plot_pcca_scores <- as.data.frame(scores(winter_plot_pcca, display = "sites", scaling = "sites")) %>%
  cbind(winter_preds)

ggplot(winter_plot_pcca_scores, aes(CCA1, CCA2, color = rod_era)) + 
  geom_point()  +
  stat_ellipse() +
  facet_wrap(vars(combined_trt))

```

# Summer

## CA

```{r}

summer_plot_abund_matrix <- summer_plot_abunds %>%
  ungroup() %>%
  filter(plot_total_abundance >0 ) %>%
  select(-c(year, plot, season, combined_trt, empty_plot, quadrats_censused, plot_total_abundance)) %>%
  mutate_all(sqrt)


summer_plot_ca <- cca(summer_plot_abund_matrix)

(summer_plot_ca$CA$eig / summer_plot_ca$tot.chi)[1:5]


summer_preds <-  summer_plot_abunds %>%
  ungroup() %>%
  filter(plot_total_abundance > 0) %>%
  select((c(plot, year, combined_trt)))%>%
  mutate(rod_era = as.ordered(ifelse(year < 1997, "a",
                                     ifelse(year < 2010, "b",
                                            "c"))))

summer_plot_ca_scores <- as.data.frame(scores(summer_plot_ca, display = "sites", scaling = "sites")) %>%
  cbind(summer_preds)

ggplot(summer_plot_ca_scores, aes(CA1, CA2, color = rod_era)) + 
  geom_point()  +
  stat_ellipse() +
    ylim(-2.5, 1) +
  facet_wrap(vars(combined_trt))
```


## pCCA

The plotted axes account for a combined 9% of total variation.

```{r}

summer_plot_pcca <- cca(summer_plot_abund_matrix ~  rod_era + combined_trt + Condition(plot), summer_preds)

summer_plot_pcca

(summer_plot_pcca$CCA$eig / summer_plot_pcca$tot.chi)

summer_plot_pcca_scores <- as.data.frame(scores(summer_plot_pcca, display = "sites", scaling = "sites")) %>%
  cbind(summer_preds)

ggplot(summer_plot_pcca_scores, aes(CCA1, CCA2, color = rod_era)) + 
  geom_point()  +
  stat_ellipse() +
  facet_wrap(vars(combined_trt))

```