---
title: "Other climate variables"
output: 
    github_document:
       df_print: kable
       toc: true
---

```{r setup, include=FALSE}
library(portalr)
library(dplyr)
library(ggplot2)
library(soar)
theme_set(theme_bw())
knitr::opts_chunk$set(echo = FALSE, fig.dim = c(6, 3))

water_scale <- scale_color_viridis_d(option = "turbo", begin = .1, end = .8, direction = -1)

temp_fscale <- scale_fill_viridis_d(option = "turbo", begin = .1, end = .8, direction = 1)
temp_scale <- scale_color_viridis_d(option = "turbo", begin = .1, end = .8, direction =1)
water_fscale <- scale_fill_viridis_d(option = "turbo", begin = .1, end = .8, direction = -1)
era_grid <-   facet_grid(cols = vars(oera), space = "free", scales = "free_x")

era_break_dates <- as.Date(
  c(
    "1996-01-01",
    "2010-01-01"
  ),
  format = "%Y-%m-%d"
)

```

```{r}

weather <- weather(level = "monthly", fill = T)

weather <- weather %>%
    dplyr::mutate(date = format(lubridate::parse_date_time(paste(month, year, sep=" "),
                                                           orders = c("m/Y")), "%m-%Y")) %>%
    dplyr::mutate(date = as.Date(paste("01",date,sep="-"), format="%d-%m-%Y"))  %>%
  mutate(numdate = as.numeric(date)) %>%
  mutate(oera = as.ordered(ifelse(year < 1996, "a", ifelse(year < 2010, "b", "c")))) %>%
  filter(year > 1988)

```


## Summary

Precipitation and min temp seem to have had a low/high period since 2010, respectively. The number of days > 35 C have increased since the early 2000s. Mean and min temps have may have weakly increased, but it's iffy. 

None of these shifts is as pronounced as the shift towards lower precip and higher temps seen from the late 1980s - early 1990s. 

I think the drought index captures this story more succintly. 

## Precipitation

### Precip anomaly

All of the anomalies come from `portalr::weather()`. Major hat tip to Glenda for writing that function and putting me on this approach to plotting anomalies (see also the aesthetic for NDVI, drought.)

Monthly precip / PRISM 30-year normal.

```{r}

ggplot(weather, aes(date, anomaly_ppt - 1, color = anomaly_ppt > 1)) +
  geom_col() +
  era_breaks +
  water_scale +
  theme(legend.position = "none")  +
  ylab("Precip anomaly \nProportion of long term mean - 1") +
  ggtitle("Precip anomaly", subtitle = "Proportion of PRISM 30 year normal")

```

### Summer precip

Calculated as the total precipitation from April-September each year, visualized as the proportion of the long term mean.

There is a notable drop approaching 2020, but note that 2005-2015 is not extraordinary compared to the 1990s-2000s.

```{r}

summer_precip <- weather %>%
  filter(month %in% c(4:9)) %>%
  group_by(year) %>%
  summarize(s_precip = sum(precipitation)) %>%
  ungroup() 

summer_mean_precip <- mean(summer_precip$s_precip)

summer_precip <- summer_precip %>%
  mutate(from_ltmean = s_precip / summer_mean_precip)

ggplot(summer_precip, aes(year, from_ltmean, fill = from_ltmean > 1)) + geom_col(aes(y = from_ltmean - 1)) + water_fscale + geom_vline(xintercept = c(1996, 2010), linetype = 3) + theme(legend.position = "none") + ylab("Summer precipitation \nProportion of long term mean - 1 ") + ggtitle("Summer precip", subtitle = "Proportion of long term mean")


```

### Winter precip


Calculated as the total precipitation from October-March the following year, visualized as the proportion of the long term mean.

```{r}


winter_precip <- weather %>%
  filter(month %in% c(1:3, 10:12)) %>%
  mutate(water_year = ifelse(month > 5, year + 1, year)) %>%
  group_by(water_year) %>%
  summarize(w_precip = sum(precipitation)) %>%
  ungroup() %>%
  filter(water_year < 2020)

winter_mean_precip <- mean(winter_precip$w_precip)

winter_precip <- winter_precip %>%
  mutate(from_ltmean = w_precip / winter_mean_precip)

ggplot(winter_precip, aes(water_year, from_ltmean, fill = from_ltmean > 1)) + geom_col(aes(y = from_ltmean - 1)) + water_fscale + geom_vline(xintercept = c(1996, 2010), linetype = 3) + theme(legend.position = "none") + ylab("winter precipitation \nProportion of long term mean - 1 ") + ggtitle("Winter precip", subtitle = "Proportion of long term mean")


```

## Temperature

### Mean temp

Based on PRISM 30-year normal.

```{r}

ggplot(weather, aes(date, anomaly_meant, color = anomaly_meant > 0)) +
  geom_col() +
  era_breaks +
  temp_scale +
  theme(legend.position = "none")  +
  ylab("Mean temperature anomaly") +
  ggtitle("Mean temperature anomaly", subtitle = "Difference from PRISM 30 year normal")

```

### Max temp

```{r}

ggplot(weather, aes(date, anomaly_maxt, color = anomaly_maxt > 0)) +
  geom_col() +
  era_breaks +
  temp_scale +
  theme(legend.position = "none")  +
  ylab("Max temperature anomaly") +
  ggtitle("Max temperature anomaly", subtitle = "Difference from PRISM 30 year normal")

```

### Min temp

```{r}


ggplot(weather, aes(date, anomaly_mint, color = anomaly_mint > 0)) +
  geom_col() +
  era_breaks +
  temp_scale +
  theme(legend.position = "none")  +
  ylab("Min temperature anomaly") +
  ggtitle("Min temperature anomaly", subtitle = "Difference from PRISM 30 year normal")

```


### Days above 35 C

The number of days each year when the max temp exceeded 35C. 

```{r}

hot_days <- portalr::weather(level = "daily", fill = T)

hot_days <- hot_days %>%
  group_by_all() %>%
  mutate(is_hot = maxtemp > 35) %>%
  ungroup() %>%
  group_by(year) %>%
  summarize(nhot = sum(is_hot, na.rm = T),
            meanhot = mean(is_hot, na.rm = T),
            ndays = sum(!is.na(is_hot))) %>%
  ungroup() %>%
  filter(year > 1988)

hot_days <- hot_days %>%
  filter(year < 2020)

hot_days_lt <- mean(hot_days$nhot, na.rm =T)

hot_days <- hot_days %>%
  group_by_all() %>%
  mutate(from_lt = nhot - hot_days_lt) %>%
  ungroup()

ggplot(hot_days, aes(year, from_lt, fill = from_lt > 0)) +
  geom_col() +
  temp_fscale +
  geom_vline(xintercept = c(1996, 2010), linetype = 3) +
  theme(legend.position = "none") +
  ggtitle("Days above 35 C", subtitle = "Difference from long term mean") +
  ylab("Difference from long-term mean")

```





