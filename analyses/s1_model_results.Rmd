---
title: "Appendix S1 - Full model results"
output: 
     # word_document:
     #    df_print: kable
     #    toc: false
     #    reference_docx: style_reference.docx
   # github_document:
   #      df_print: kable
   #      toc: true
   pdf_document
---

```{r setup, include=T, echo = T}
knitr::opts_chunk$set(echo = T)

library(soar)
library(ggplot2)
library(dplyr)
library(multipanelfigure)
library(nlme)
library(emmeans)

theme_set(theme_bw())


# Get data using `portalr`:
#treatl <- get_treatment_means() 
# Alternatively, read data from `data/`:
 treatl <- read.csv(here::here("data", "treatl.csv"), stringsAsFactors = T)

 treatl <- treatl %>%
   mutate(censusdate = as.Date(censusdate),
          oera = ordered(oera),
          oplottype = ordered(oplottype))
 
pb <- get_pb(treatl) 

pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)
energy_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)

```


# Compensation & total energy use

## Compensation

Model: 


```{r, echo =T}


comp_mean_gls <- gls(smgran_comp ~ oera,  correlation = corCAR1(form = ~ period), data = compensation)

comp_mean_gls_emmeans <- emmeans(comp_mean_gls, specs = ~ oera)

comp_mean_pred <-  as.data.frame(comp_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(compensation)

```


Results of generalized least squares:

```{r}

(summary(comp_mean_gls))
```


Estimates: 

```{r}

compensation_estimates <- as.data.frame(comp_mean_gls_emmeans)
compensation_estimates

```

Contrasts:

```{r}
compensation_contrasts <- as.data.frame(pairs(comp_mean_gls_emmeans))
compensation_contrasts

```

## Total energy use

Model:

```{r, echo = T}

totale_mean_gls <- gls(total_e_rat ~  oera,  correlation = corCAR1(form = ~ period), data = energy_ratio)

  
```

Model summary:

```{r}

summary(totale_mean_gls)
```


Estimates: 

```{r}
totale_mean_gls_emmeans <- emmeans(totale_mean_gls, specs = ~ oera)

totale_estimates <- as.data.frame(totale_mean_gls_emmeans)
totale_estimates

```

Contrasts:

```{r}
totale_contrasts <- as.data.frame(pairs(totale_mean_gls_emmeans))
totale_contrasts

```

# Community composition

## Kangaroo rats

Model:

```{r, echo = T}

dipo_dat <- treatl %>%
  mutate(dipo_prop = dipo_e / total_e,
         smgran_prop= smgran_e / total_e) %>%
  group_by(oplottype) %>%
  mutate(smgran_prop_ma = maopts(smgran_prop),
         dipo_prop_ma = maopts(dipo_prop)) %>%
  ungroup() 

dipo_c_dat <- dipo_dat %>%
  filter(oplottype == "CC")

dipo_glm <- glm(dipo_prop ~ oera, family = quasibinomial(), data= dipo_c_dat)



```

Model summary:

```{r}

summary(dipo_glm)
```


Estimates:

Estimates from `emmeans` differ numerically (very slightly) from estimates obtained via `predict()` and back transformation. Below are estimates from `emmeans`, because those are what are used for contrasts.

```{r}


dipoemmeans <- regrid(emmeans(dipo_glm, specs = ~ oera))

dipoestimates <- as.data.frame(dipoemmeans)

dipoestimates

```

Estimates from `predict`:

```{r}

dipo_glm_se <- est_glm_ilink(dipo_glm, dipo_c_dat) %>%
  left_join(select(dipo_c_dat, period, dipo_prop_ma)) %>%
  mutate(Treatment = ifelse(oplottype == "CC", "Control", "Exclosure"),
         Rodents = "All small granivores\n(non-Dipodomys)") %>%
  rename(rod_prop_ma = dipo_prop_ma)

select(dipo_glm_se, oera, est, lower, upper) %>% distinct()

```


Contrasts:

```{r}
dipocontrasts <- as.data.frame(pairs(dipoemmeans))
dipocontrasts

```


## C. baileyi

Model:

```{r, echo = T}

pb_glm_treat <- glm(pb_prop ~ oera * oplottype, family = quasibinomial(), data= pb_nozero)

```

Model summary:

```{r}

summary(pb_glm_treat)
```


Estimates: 

```{r}

pb_emmeans <- regrid(emmeans(pb_glm_treat, specs = ~ oera | oplottype))

pb_estimates <- as.data.frame(pb_emmeans)

pb_estimates

```


Estimates from `predict`:

```{r}

pb_glm_treat_se <- est_glm_ilink(pb_glm_treat, pb_nozero) %>%
  full_join(select(pb, period, oplottype, pb_prop_ma, censusdate)) %>%
  mutate(Treatment = ifelse(oplottype == "CC", "Control", "Exclosure"),
         Rodents = "C. baileyi") %>%
  rename(rod_prop_ma = pb_prop_ma)

select(pb_glm_treat_se, oplottype, oera, est, lower, upper) %>% distinct()

```

Contrasts:

```{r}
pb_contrasts <- as.data.frame(pairs(pb_emmeans))
pb_contrasts

```
