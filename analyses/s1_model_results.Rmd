---
title: "Appendix S1 - Full model results"
subtitle: "Supplemental information for Diaz and Ernest, “Maintenance of community function through compensation breaks down over time in a desert rodent community”. In review at Ecology."
output:
  # html_document:
  #   toc: yes
  #   df_print: paged
  word_document:
    df_print: kable
    reference_docx: default_gdoc.docx
    toc: yes
  # pdf_document:
  #   toc: yes
---

```{r setup, include=T, echo = F, results = F, warning = F, message = F}
knitr::opts_chunk$set(echo = F,  warning = F, message = F)

library(soar)
library(ggplot2)
library(dplyr)
library(multipanelfigure)
library(nlme)
library(emmeans)

theme_set(theme_bw())


# Get data using `portalr`:
#treatl <- get_treatment_means() 
# Alternatively, read data from `data/`:
# treatl <- read.csv(here::here("data", "treatl.csv"), stringsAsFactors = T)

# This section is new. Load data using `get_plot_totals` so that you can remove an exclosure plot (resulting in a balanced set of 4 exclosures and 4 controls)

plotl <- get_plot_totals()

plot_types <- list_plot_types() %>% filter(plot_type == "EE")

set.seed(1977) # 1977 is my usual Portal seed
remove_plot <- sample(plot_types$plot, 1, F)

plotl <- plotl %>%
  filter(plot != remove_plot)

treatl <- plots_to_treatment_means(plotl) 

treatl <- treatl %>%
   mutate(censusdate = as.Date(censusdate),
          oera = ordered(oera),
          oplottype = ordered(oplottype))
 
pb <- get_pb(treatl) 

pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)
energy_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)

```


<!-- Because there are 5 exclosures and 4 controls, we remove 1 exclosure plot. Using `set.seed(1977)` and sampling 1 plot from the 5 possible exclosures to remove, we remove plot `r remove_plot`.  -->

\newpage

# Compensation



```{r, echo =F}


comp_mean_gls <- gls(smgran_comp ~ oera,  correlation = corCAR1(form = ~ period), data = compensation)

comp_mean_gls_emmeans <- emmeans(comp_mean_gls, specs = ~ oera)

comp_mean_pred <-  as.data.frame(comp_mean_gls_emmeans) %>%
  mutate(oera = ordered(oera)) %>%
  right_join(compensation)

```


### Table S1. Coefficients from GLS for compensation

```{r}
compensation_coef <- as.data.frame(summary(comp_mean_gls)$tTable)
compensation_coef
```


### Table S2. Estimates from GLS for compensation 

```{r}

compensation_estimates <- as.data.frame(comp_mean_gls_emmeans)
compensation_estimates

```

### Table S3. Contrasts from GLS for compensation 

```{r}
compensation_contrasts <- as.data.frame(pairs(comp_mean_gls_emmeans)) %>%
  mutate(p.value = round(p.value, digits = 4))
compensation_contrasts

```
\newpage
 
# Total energy use

```{r, echo = F}

totale_mean_gls <- gls(total_e_rat ~  oera,  correlation = corCAR1(form = ~ period), data = energy_ratio)

  
```


### Table S4. Coefficients from GLS on total energy ratio

```{r}

te_coef <- as.data.frame(summary(totale_mean_gls)$tTable)

te_coef

```


### Table S5. Estimates from GLS on total energy ratio

```{r}
totale_mean_gls_emmeans <- emmeans(totale_mean_gls, specs = ~ oera)

totale_estimates <- as.data.frame(totale_mean_gls_emmeans)
totale_estimates

```


### Table S6. Contrasts from GLS on total energy ratio

```{r}
totale_contrasts <- as.data.frame(pairs(totale_mean_gls_emmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
totale_contrasts

```

\newpage



# Kangaroo rat proportional energy use


```{r, echo = F}

dipo_dat <- treatl %>%
  mutate(dipo_prop = dipo_e / total_e,
         smgran_prop= smgran_e / total_e) %>%
  group_by(oplottype) %>%
  mutate(smgran_prop_ma = maopts(smgran_prop),
         dipo_prop_ma = maopts(dipo_prop)) %>%
  ungroup() 

dipo_c_dat <- dipo_dat %>%
  filter(oplottype == "CC")

dipo_glm <- glm(dipo_prop ~ oera, family = binomial(), data= dipo_c_dat)



```

### Table S7. Coefficients from GLM on Dipodomys energy use.

```{r}

dipo_coef <- as.data.frame(summary(dipo_glm)$coefficients)
dipo_coef

```


### Table S8. Estimates from GLM on Dipodomys energy use.

```{r}


dipoemmeans <- regrid(emmeans(dipo_glm, specs = ~ oera))

dipoestimates <- as.data.frame(dipoemmeans)

dipoestimates

```


### Table S9. Contrasts from GLM on Dipodomys energy use.

```{r}
dipocontrasts <- as.data.frame(pairs(dipoemmeans))%>%
  mutate(p.value = round(p.value, digits = 4))
dipocontrasts

```

\newpage

# C. baileyi proportional energy use


```{r, echo = F}

pb_glm_interaction <- glm(pb_prop ~ oera * oplottype, family = binomial(), data= pb_nozero)
pb_glm_nointeraction <- glm(pb_prop ~ oera + oplottype, family = binomial(), data= pb_nozero)
pb_glm_notreat <- glm(pb_prop ~ oera, family = binomial(), data= pb_nozero)
# 
# AIC(pb_glm_interaction)
# AIC(pb_glm_nointeraction)
# AIC(pb_glm_notreat)
# 
# anova(pb_glm_interaction, pb_glm_nointeraction, test = "Chi")
# anova(pb_glm_nointeraction, pb_glm_notreat, test = "Chi")

```


<!-- Note that a model fit as `pb_proportional_energy_use ~ era + treatment + era:treatment` does not outperform a model fit without the interaction term, or `pb_proportional_energy_use ~ era + treatment` (AIC for the no interaction model = 231 compared to 237 for the interaction model; p-value for an anova Chi-squared comparison of the two models = 0.15). We therefore use the model without the interaction term.  -->


### Table S10. Coefficients from GLM on C. baileyi energy use

```{r}

pb_coef <- as.data.frame(summary(pb_glm_nointeraction)$coefficients)
pb_coef

```


### Table S11. Estimates from GLM on C. baileyi energy use

```{r}

pb_emmeans <- regrid(emmeans(pb_glm_nointeraction, specs = ~ oera))

pb_estimates <- as.data.frame(pb_emmeans)

pb_estimates

```

### Table S12. Contrasts from GLM on C. baileyi energy use.

```{r}
pb_contrasts <- as.data.frame(pairs(pb_emmeans)) %>%
  mutate(p.value = round(p.value, digits = 4))
pb_contrasts

```
