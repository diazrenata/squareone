---
title: "New plots with 81 data"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rats <- read.csv(here::here("lore", "1981_competition", "1981_data_complete.csv"), stringsAsFactors = F)
rat_totals <- read.csv(here::here("lore", "1981_competition", "1981_data_statevars.csv"), stringsAsFactors = F)
library(dplyr)
library(ggplot2)
library(gratia)
```

```{r, echo = F}

ggplot(filter(rat_totals, type != "other"), aes(period, nind, color = brown_trtmnt)) +
  geom_line() +
  geom_point()+
  theme_bw() +
  facet_wrap(vars(type), ncol = 1, scales = "free_y") +
  geom_vline(xintercept = 3.5) +
  geom_hline(yintercept = 0) +
  scale_colour_viridis_d(end = .8)

```
```{r}
load_mgcv()
df <- data_sim("eg4")
m <- gam(y ~ fac + s(x2, by = fac) + s(x0), data = df, method = "REML")
difference_smooths(m, smooth = "s(x2)")

rat_totals <- rat_totals %>%
  mutate(brown_trtmnt = as.factor(brown_trtmnt))

n_gam <- gam(nind ~  brown_trtmnt + s(period, by = brown_trtmnt), data = filter(rat_totals, type == "small_granivore"), method = "REML", family = "poisson")

n_gam_fitted <- rat_totals %>%
  filter(type == "small_granivore") %>%
  add_fitted(model = n_gam, value = "fitted")

ggplot(n_gam_fitted, aes(period, nind, shape = brown_trtmnt)) +
  geom_line() +
  geom_line(aes(period, fitted), color = "blue") +
  facet_wrap(vars(brown_trtmnt))

n_gam_diff <- difference_smooths(n_gam, smooth = "s(period)", newdata = select(filter(rat_totals, type == "small_granivore"), period, brown_trtmnt))

head(n_gam_diff)

draw(n_gam)

ggplot(n_gam_diff, aes(period, diff)) +
  geom_line() +
  geom_line(aes(period, lower)) +
  geom_line(aes(period, upper)) +
  theme_bw() +
  geom_hline(yintercept = 0)

```

I'm not sure what the difference is between, 


`nind ~ brown_trtmnt + s(period, by = brown_trtmnt)`


`nind ~ s(period, by = brown_trtmnt)`

and even more complicated models, like including effects for plot or somehow fitting all 3 types (krats, small granivores, and omnivores) within the same model.

