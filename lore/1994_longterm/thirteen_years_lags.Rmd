---
title: "Plots from Heske, Brown, and Mistry 1994"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rats <- read.csv(here::here("lore", "1994_longterm", "1994_data_complete.csv"), stringsAsFactors = F)
rat_totals_1977 <- read.csv(here::here("lore", "1994_longterm", "1994_data_statevars_1977.csv"), stringsAsFactors = F)
rat_totals_1988 <- read.csv(here::here("lore", "1994_longterm", "1994_data_statevars_1988.csv"), stringsAsFactors = F)
library(dplyr)
library(ggplot2)

```

```{r, echo = F}


ggplot(filter(rat_totals_1977, type != "other", period > 2), aes(period, nind, color = trtmnt_1977)) +
  geom_line() +
  geom_point()+
  theme_bw() +
  facet_wrap(vars(type), ncol = 1, scales = "free_y") +
  geom_hline(yintercept = 0) +
  scale_colour_viridis_d(end = .8)


rats_1977_thrmo_avg <- rat_totals_1977 %>%
 # filter(period > 2) %>%
  mutate(three_month_section = floor((period) / 3) + 1) %>%
  group_by(three_month_section, type, trtmnt_1977) %>%
  summarize(nind = mean(nind),
            mean_date = mean(as.Date(censusdate))) %>%
  ungroup()

ggplot(filter(rats_1977_thrmo_avg, type != "other", three_month_section < 52), aes(mean_date, nind, color = trtmnt_1977)) +
  geom_line() +
  geom_point()+
  theme_bw() +
  facet_wrap(vars(type), ncol = 1, scales = "free_y") +
  geom_hline(yintercept = 0) +
  scale_colour_viridis_d(end = .8)

```

```{r, echo = F}


ggplot(filter(rat_totals_1988, type != "other", period > 2), aes(period, nind, color = trtmnt_1988)) +
  geom_line() +
  geom_point()+
  theme_bw() +
  facet_wrap(vars(type), ncol = 1, scales = "free_y") +
  geom_hline(yintercept = 0) +
  scale_colour_viridis_d(end = .8) +
  geom_vline(xintercept = 118)


rats_1988_thrmo_avg <- rat_totals_1988 %>%
 # filter(period > 2) %>%
  mutate(three_month_section = floor((period) / 3) + 1) %>%
  group_by(three_month_section, type, trtmnt_1988) %>%
  summarize(nind = mean(nind),
            mean_date = mean(as.Date(censusdate))) %>%
  ungroup()

ggplot(filter(rats_1988_thrmo_avg, type != "other", three_month_section < 52), aes(mean_date, nind, color = trtmnt_1988)) +
  geom_line() +
  geom_point()+
  theme_bw() +
  facet_wrap(vars(type), ncol = 1, scales = "free_y") +
  geom_hline(yintercept = 0) +
  scale_colour_viridis_d(end = .8) +
  geom_vline(xintercept = as.Date("1988-01-01"))

```
```{r}

rat_totals <- rat_totals_1977 %>%
  rename(trtmnt = trtmnt_1977) %>%
  mutate(time_period = "seventies") %>%
  bind_rows(mutate(rename(rat_totals_1988, trtmnt = trtmnt_1988), time_period = "eighties")) %>%
  mutate(grassy = ifelse(time_period == "seventies", ifelse(trtmnt == "exclosure", TRUE, FALSE), FALSE))

ggplot(filter(rat_totals, type == "small_granivore", period > 2, period < 117), aes(period, nind, color = grassy)) +
  geom_line() +
  facet_wrap(vars(trtmnt), scales = "free_y") +
  theme_bw() +
  scale_color_viridis_d(option = "plasma", end = .8)


ggplot(filter(rat_totals, type == "small_granivore", period > 2, period < 117), aes(period, nind, color = trtmnt)) +
  geom_line() +
  facet_wrap(vars(time_period), scales = "free_y") +
  theme_bw() +
  scale_color_viridis_d(option = "plasma", end = .8)

ggplot(filter(rat_totals, type == "small_granivore", period > 2, period < 117), aes(period, nind, color = time_period)) +
  geom_line() +
  facet_wrap(vars(trtmnt), scales = "fixed") +
  theme_bw() +
  scale_color_viridis_d(option = "plasma", end = .8)

```

The eighties exclosures were controls prior, so it makes sense that that TS is in line with the eighties controls and the seventies controls. 

The thinking is, that the eighties exclosures are NOT grassy, but that the seventies exclosures are grassy. Grass is good for small granivores. 

How many small granivores do we see on the eighties vs seventies exclosures following the implementation of the treatment?


```{r}

ggplot(filter(rat_totals, type == "small_granivore"), aes(as.Date(censusdate), nind, color = time_period)) +
  geom_line(size = 2) +
  facet_wrap(vars(trtmnt), scales = "free", ncol = 1) +
  theme_bw() +
  scale_color_viridis_d(option = "plasma", end = .8) +
  theme(legend.position = "top")+
  geom_vline(xintercept = as.Date("1988-01-01"))
  
rat_totals <- rat_totals %>%
  mutate(trtmnt_period = paste(time_period, trtmnt, sep = "_"))

ggplot(filter(rat_totals, type == "small_granivore"), aes(as.Date(censusdate), nind, color= trtmnt, group = trtmnt_period)) +
  geom_line(size = 2) +
  theme_bw() +
  facet_wrap(vars(grassy), scales = "free", ncol = 1) +
  scale_color_viridis_d(end = .8) +
  theme(legend.position = "top")+
  geom_vline(xintercept = as.Date("1988-01-01"))
```

I'm **not sure** about this interpretation, but here is the logic around these plots...


they generally represent a different approach from rmANOVA, in that rmANOVA is (kind of) about chunking a TS into time periods and then treating within-time-period as homogenous. rather than, the gam difference approach is a little more about watching things converge and diverge. you don't have to specify the time periods a priori and in fact you should **not**. 

we see these bugbears also in the thibault bailey's papers. the baselines/conditions shift over the decades at the site, making it more and more important to look at divergence **between treatments at the same time**, than to chunk things into time periods.

(there is however an important time period in that the 1988 treatments are implemented in Jan-Feb 1988!)

look first at purple and orange plots. the controls (top panel) mirror each other. the exclosures, the 1980s exclosures are well below the 1970s exclosures up until the treatment. this makes sense, bc at that time they were controls. HOWEVER. they immediately match the 1970s exclosures post treatment. BUT, that's as much because the abundances on the 70s plots have dropped, as because the abundances on the 80s plots have increased. there's not an obvious increase in the 80s time series **precipitated by the treatment**, although there **is an increase** that **starts some months before the treatment is implemented**. with the caveat that humans are good at retrofitting pattern to data, but. this isn't a slam-dunk "treatment caused an increase" situation.

but then look at the (bottom) green and purple plots. The bottom panel is the "grassy" plots, aka the exclosures that were implemented in 1977. **All of the control plots** are starting to increase around 1987-88. However following 1988, the **treated plots** diverge from the ones that stayed controls and stay high while the controls drop out again. 


```{r}

ggplot(filter(rat_totals, type == "small_granivore", period > 100, period < 155), aes(as.Date(censusdate), nind, color= trtmnt, group = trtmnt_period)) +
  geom_line(size = 2) +
  theme_bw() +
  facet_wrap(vars(grassy), scales = "free", ncol = 1) +
  scale_color_viridis_d(end = .8) +
  theme(legend.position = "top")+
  geom_vline(xintercept = as.Date("1988-01-01"))

```