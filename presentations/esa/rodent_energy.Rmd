---
title: "Rodent energy use results"
output:
  github_document:
       df_print: kable
       toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.dim = c(3,3))
library(soar)
library(ggplot2)
library(dplyr)
library(mgcv)
library(gratia)
library(portalr)
theme_set(theme_bw())
library(SPEI)

weather <- weather(level = "monthly", fill = T)

weather <- weather %>%
    dplyr::mutate(date = format(lubridate::parse_date_time(paste(month, year, sep=" "),
                                                           orders = c("m/Y")), "%m-%Y")) %>%
    dplyr::mutate(date = as.Date(paste("01",date,sep="-"), format="%d-%m-%Y"))  %>%
  mutate(numdate = as.numeric(date))


weather_full <- expand.grid(year = c(min(weather$year) : max(weather$year)),
  month = c(1:12)
) %>%
  left_join(mutate(weather, month = as.numeric(month), year = as.numeric(year))) %>%
  mutate(datestr = paste0(year, "-01-", month)) %>%
  mutate(newdate = as.Date(datestr, format = "%Y-%d-%m")) %>%
  arrange(newdate)

precip_ts <- ts(weather_full$precipitation, start = weather_full$newdate[1], frequency = 12)

precip_ts_interp <- imputeTS::na_interpolation(precip_ts)

meant_ts <- ts(weather_full$meantemp, start = weather_full$newdate[1], frequency = 12)

meant_ts_interp <- imputeTS::na_interpolation(meant_ts)

weather_full_drought <- weather_full %>%
  mutate(precip_interp = precip_ts_interp,
         temp_interp = meant_ts_interp) %>% 
  filter(year > 1988, year < 2020) %>%
  mutate(thorn = SPEI::thornthwaite(temp_interp, lat = 31.938908)) %>%
  mutate(cbal = precip_interp - thorn) %>%
  mutate(spei1 = spei(cbal, 1)$fitted, 
spei6 = spei(cbal, 6)$fitted, 
         spei12 = spei(cbal, 12)$fitted,
         spei18 = spei(cbal, 18)$fitted) %>%
  mutate(oera = as.ordered(ifelse(year < 1996, "a", ifelse(year < 2010, "b", "c"))))

library(nlme)
library(emmeans)
treatl <- get_treatment_means() %>%
  remove_switch()

pb <- get_pb(treatl)
pb_nozero <- pb %>%
  filter(as.numeric(oera) > 1)
energy_ratio <- get_e_ratio(treatl)
compensation <- get_compensation(treatl)

era_df <- soar::make_era_df()


  both_scale <- scale_color_viridis_d(begin = .1, end = .8)
cc_scale <- scale_color_viridis_d(begin = .1, end = .1)
ee_scale <- scale_color_viridis_d(begin = .8, end =.8)
both_fscale <- scale_fill_viridis_d(begin = .1, end = .8)
cc_fscale <- scale_fill_viridis_d(begin = .1, end = .1)
ee_fscale <- scale_fill_viridis_d(begin = .8, end =.8)


```


# Overview of compositonal shift

```{r, fig.dim  = c(5, 2.5)}

controls_composition <- treatl %>%
  filter(plot_type == "CC") %>%
  select(censusdate, oera, total_e, smgran_e, pb_e) %>%
  mutate(pb = pb_e / total_e,
         small_granivores = smgran_e / total_e,
         all_rodents = total_e / total_e) %>%
  select(censusdate, pb, small_granivores, all_rodents) %>%
  tidyr::pivot_longer(cols = c(pb, small_granivores, all_rodents), names_to = "rodents", values_to = "proportion") %>% 
  group_by(rodents) %>%
  mutate(proportion_ma = maopts(proportion)) %>%
  ungroup() %>%
  mutate(Rodents = ifelse(rodents == "pb", "C. baileyi", ifelse(rodents == "small_granivores",  "All small granivores (non-kangaroo rats)", "All rodents"))) %>%
  mutate(month = format.Date(censusdate, "%m"),
         year = format.Date(censusdate, "%Y"))  %>%
  mutate(month = as.numeric(month),
         year = as.numeric(year)) %>%
  left_join(weather_full_drought)


ggplot(filter(controls_composition, rodents != "all_rodents"), aes(censusdate, proportion_ma, color = Rodents)) +
  geom_line() +
  scale_color_viridis_d(option = "turbo", begin = .2, end = .8) +
  ylim(0, 1) +
  ggtitle("Rodent community composition - controls") +
  ylab("Proportion of total energy use") + xlab("Date") +
  theme(legend.position = "bottom", ) +
  geom_hline(yintercept = 1)


ggplot(filter(controls_composition, rodents  == "pb"), aes(censusdate, proportion_ma)) +
  geom_line() +
  scale_color_viridis_d(option = "turbo", begin = .2, end = .8) +
  ylim(0, 1) +
  ggtitle("C. baileyi share of energy use") +
  ylab("Proportion of total energy use") + xlab("Date") +
  theme(axis.title = element_text(size = 15), axis.text = element_text(size = 15)) +
  geom_hline(yintercept = 1) +
  geom_point(data = filter(controls_composition, as.numeric(spei18) < -1), aes(censusdate, 1.03), color = "red") +
 # geom_text(data = NULL, aes(as.Date("1991-05-01"), 1.03), label = "Drought", color = "red") +
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1))

ggplot(filter(controls_composition, rodents  == "small_granivores"), aes(censusdate, proportion_ma)) +
  geom_line() +
  scale_color_viridis_d(option = "turbo", begin = .2, end = .8) +
  ggtitle("Small granivore share of energy use") +
  ylab("Proportion of total energy use") + xlab("Date") +
  theme(axis.title = element_text(size = 15), axis.text = element_text(size = 15)) +
  geom_hline(yintercept = 1) +
 # geom_point(data = filter(controls_composition, as.numeric(spei18) < -1), aes(censusdate, 1.03), color = "red") +
  #geom_text(data = NULL, aes(as.Date("1991-05-01"), 1.03), label = "Drought", color = "red") +
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1))

```


Small granivore (gold) and PB (blue) energy use as a proportion of the total energy use, all on control plots. The remainder is kangaroo rats.

1. PB is now essentially absent on controls.
1. Small granivores now account for a greater proportion of total energy use on control plots than prior to PB's establishment, even now that PB has declined.


```{r}

era_means <- treatl %>%
  group_by(oplottype, oera) %>%
  summarize(pb_e = mean(pb_e),
            dipo_e = mean(dipo_e),
            tinygran_e = mean(tinygran_e)) %>%
  ungroup() %>%
  tidyr::pivot_longer(cols = c("pb_e", "dipo_e", "tinygran_e"), names_to = "rodents", values_to = "e")

ggplot(filter(era_means, as.numeric(oera) == 1), aes(oplottype, e, fill = rodents)) + geom_col() + theme(legend.position = "none")+ scale_fill_viridis_d() + ylab("Energy use (kJ)") + xlab("Treatment") + theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 15), axis.title = element_text(size = 15))

ggplot(filter(era_means, as.numeric(oera) == 2), aes(oplottype, e, fill = rodents)) + geom_col() + theme(legend.position = "none")+ scale_fill_viridis_d() + ylab("Energy use (kJ)") + xlab("Treatment") + theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 15), axis.title = element_text(size = 15))

       
ggplot(filter(era_means, as.numeric(oera) == 3), aes(oplottype, e, fill = rodents)) + geom_col() + theme(legend.position = "none")+ scale_fill_viridis_d() + ylab("Energy use (kJ)") + xlab("Treatment")  + theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 15), axis.title = element_text(size = 15))

       
```

```{r, fig.dim = c(12,4)}
ggplot(era_means, aes(oplottype, e, fill = rodents)) + geom_col() + facet_wrap(vars(oera))+ scale_fill_viridis_d()

```

# HYPOTHETICALS

```{r}

fake_3 <- filter(era_means, as.numeric(oera) == 3)

fake_3$e[6] <- era_means$e[13] + era_means$e[15]
fake_3$e[4] <- 0


ggplot(filter(fake_3, as.numeric(oera) == 3), aes(oplottype, e, fill = rodents)) + geom_col() + theme(legend.position = "none")+ scale_fill_viridis_d() + ylab("Energy use (kJ)") + xlab("Treatment") + theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 15), axis.title = element_text(size = 15))



```


```{r}

fake_3 <- filter(era_means, as.numeric(oera) == 3)

fake_3$e[6] <- fake_3$e[3]
fake_3$e[4] <- 0


ggplot(filter(fake_3, as.numeric(oera) == 3), aes(oplottype, e, fill = rodents)) + geom_col() + theme(legend.position = "none")+ scale_fill_viridis_d() + ylab("Energy use (kJ)") + xlab("Treatment")  + theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 15), axis.title = element_text(size = 15), title = element_text(size = 15), legend.title = element_text(size = 12))


```


```{r, fig.dim = c(9,6)}
legend_dat <- fake_3 %>%
  select(rodents) %>% 
  distinct() %>%
  mutate(Rodents  = c("C. baileyi","Kangaroo rats", "Other small granivores")) %>%
  mutate(Rodents = as.ordered(Rodents))

levels(legend_dat$Rodents) <- c("Kangaroo rats", "C. baileyi", "Other small granivores")

ggplot(legend_dat, aes(Rodents, 1, fill = Rodents)) + geom_col() + scale_fill_viridis_d() + theme(legend.direction = "horizontal", legend.text = element_text(size = 18))


```